<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×× ×”×œ × ×™×¡×•×™</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; }
    #loading { display:flex;align-items:center;justify-content:center;height:100vh;font-size:18px;color:#4338CA; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slideUp { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
  </style>
  <script src="https://unpkg.com/react@17.0.2/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.22.5/babel.min.js"></script>
</head>
<body>
  <div id="root"><div id="loading">â³ ×˜×•×¢×Ÿ...</div></div>
  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef, useCallback } = React;


// â”€â”€â”€ Version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP_VERSION = "5.0.0";
const APP_NAME = "×× ×”×œ × ×™×¡×•×™";

// â”€â”€â”€ i18n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LANG = {
  he: {
    appName:"×× ×”×œ × ×™×¡×•×™", appSub:"× ×™×¡×•×™ ×ª×›× ×•×Ÿ ××¡×œ×•×œ × ×¡×™×¢×” ×¢× AI",
    tabAssign:"ğŸ“‹ ×©×™×‘×•×¦×™×", tabCalendar:"ğŸ“… ×œ×•×—", tabCharts:"ğŸ“Š ×’×¨×¤×™×",
    tabEmails:"âœ‰ï¸ ××™×™×œ×™×", tabLocations:"ğŸ“ ××™×§×•××™×",
    btnLoad:"â†» ×˜×¢×Ÿ", btnSave:"ğŸ’¾ ×©××•×¨", syncLocal:"××§×•××™", syncSaving:"...",
    completed:"×”×©×œ×™××•",
    statReg:"× ×¨×©××•", statAssigned:"×©×•×‘×¦×•", statConfirmed:"××™×©×¨×•", statDeclined:"×‘×™×˜×œ×•",
    btnAddParticipant:"+ ×”×•×¡×£ × ×‘×“×§", btnAutoAssign:"âš¡ ×©×™×‘×•×¥ ××•×˜×•××˜×™ ×œ×›×•×œ×",
    btnAutoAssignSel:"âš¡ ×©×™×‘×¥ × ×‘×—×¨×™×", btnClearAssign:"ğŸ—‘ × ×§×” ×©×™×‘×•×¦×™×",
    btnExport:"â¬‡ï¸ ×™×™×¦×•×", btnImportCSV:"ğŸ“‚ ×™×‘×•× CSV", btnImportSheets:"ğŸ“‹ ×™×‘×•× ×-Sheets",
    searchPlaceholder:"ğŸ” ×—×™×¤×•×© ×©× / ××™×™×œ", filterAssigned:"×©×•×‘×¦×•/×œ×",
    filterAll:"×”×›×œ", filterYes:"×©×•×‘×¦×•", filterNo:"×œ× ×©×•×‘×¦×•", clearAll:"âœ• × ×§×” ×”×›×œ",
    colName:"×©×", colEmail:"××™××™×™×œ", colAge:"×’×™×œ", colGender:"××’×“×¨",
    colAvail:"×–××™× ×•×ª", colDay:"×™×•×", colSlot:"××©××¨×ª", colLocation:"××™×§×•×",
    colRoom:"×—×“×¨", colStatus:"×¡×˜×˜×•×¡", colLocPref:"×”×¢×“×¤×ª ××™×§×•×",
    colNotes:"×”×¢×¨×•×ª", colActions:"×¤×¢×•×œ×•×ª",
    sortAsc:"â†‘ ×¡×“×¨ ×¢×•×œ×”", sortDesc:"â†“ ×¡×“×¨ ×™×•×¨×“", clearColFilter:"âœ• × ×§×” ×¡×™× ×•×Ÿ ×¢××•×“×”",
    statusPending:"×××ª×™×Ÿ", statusAssigned:"×©×•×‘×¥", statusConfirmed:"××™×©×¨",
    statusCompleted:"×”×©×œ×™×", statusDeclined:"×‘×™×˜×œ",
    dayA:"×¨××©×•×Ÿ", dayB:"×©× ×™", dayC:"×©×œ×™×©×™", dayD:"×¨×‘×™×¢×™", dayE:"×—××™×©×™", dayF:"×©×™×©×™",
    dayPrefix:"×™×•× ",
    slotMorning:"×‘×•×§×¨", slotAfternoon:"×¦×”×¨×™×™×",
    editParticipant:"×¢×¨×™×›×ª × ×‘×“×§", addParticipant:"×”×•×¡×¤×ª × ×‘×“×§ ×™×“× ×™×ª",
    fieldName:"×©× ××œ× *", fieldEmail:"××™××™×™×œ", fieldPhone:"×˜×œ×¤×•×Ÿ",
    fieldAge:"×’×™×œ", fieldGender:"××’×“×¨", fieldStatus:"×¡×˜×˜×•×¡",
    fieldNotes:"×”×¢×¨×•×ª", fieldAvail:"×–××™× ×•×ª", fieldLocPref:"ğŸ“ ×”×¢×“×¤×ª ××™×§×•× (× ×™×ª×Ÿ ×œ×‘×—×•×¨ ××¡×¤×¨)",
    genderM:"×’×‘×¨", genderF:"××™×©×”", genderO:"××—×¨", genderPick:"×‘×—×¨",
    btnCancel:"×‘×™×˜×•×œ", btnSaveChanges:"ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×", btnAddConfirm:"âœ… ×”×•×¡×£ × ×‘×“×§",
    available:"âœ“ ×–××™×Ÿ", notAvailable:"â€”",
    noLocations:"××™×Ÿ ××™×§×•××™× ××•×’×“×¨×™×",
    menuHelp:"×”×“×¨×›×” ×•×¢×–×¨×”", menuChangelog:"×œ×•×’ ×©×™× ×•×™×™×",
    menuDark:"××¦×‘ ×›×”×”", menuLight:"××¦×‘ ×‘×”×™×¨",
    menuGmail:"×”×’×“×¨×•×ª Gmail", menuSettings:"×”×’×“×¨×•×ª",
    menuAbout:"××•×“×•×ª", menuLang:"ğŸŒ English",
    emailManualTitle:"âœï¸ ×”×•×“×¢×” ×—×•×¤×©×™×ª ×œ× ×‘×“×§×™×",
    emailThanksTitle:"ğŸ™ ×ª×•×“×” ×œ××©×ª×ª×¤×™× ×©×”×©×œ×™××•",
    btnSendThanks:"âœ‰ï¸ ×©×œ×— ×ª×•×“×”", btnSendThanksAll:"ğŸ“¨ ×©×œ×— ×ª×•×“×” ×œ×›×•×œ×",
    btnProofread:"âœï¸ ×ª×™×§×•×Ÿ ×›×ª×™×‘ (AI)", btnRewrite:"ğŸ”„ ×©×›×ª×•×‘ (AI)",
    langWarning:"×©×™× ×œ×‘: ×—×œ×§ ××”×ª×•×›×Ÿ (×©××•×ª, ×–××™× ×•×ª) ×™×™×©××¨ ×‘×¢×‘×¨×™×ª",
    bulkLocPref:"ğŸ“ ×”×¢×“×¤×”:",
    settingsTitle:"âš™ï¸ ×”×’×“×¨×•×ª × ×™×¡×•×™",
    dupTitle:"âš ï¸ × ××¦× ×›×¤×•×œ", dupOf:"××ª×•×š", dupConflicts:"×§×•× ×¤×œ×™×§×˜×™×",
    dupFrom:"ğŸ“¥ ××”×§×•×‘×¥ (×—×“×©)", dupExisting:"âœ… ×‘××¢×¨×›×ª (×§×™×™×)",
    dupFoundBy:"ğŸ” ×–×•×”×” ×›×¤×•×œ ×œ×¤×™:",
    dupSkip:"â­", dupSkipDesc:"×“×œ×’ â€” ××œ ×ª×©× ×” ×›×œ×•×", dupSkipSub:"×©××•×¨ ××ª ×”×§×™×™×, ×”×ª×¢×œ× ××”×—×“×©",
    dupMerge:"ğŸ”€", dupMergeDesc:"××–×’ â€” ×©××•×¨ ×©×™×‘×•×¥ ×•×¡×˜×˜×•×¡", dupMergeSub:"×¢×“×›×Ÿ ×–××™× ×•×ª ×•×¤×¨×˜×™×, ×©××•×¨ ×©×™×‘×•×¥",
    dupReplace:"ğŸ”", dupReplaceDesc:"×”×—×œ×£ â€” ×”×›×œ ××”×§×•×‘×¥", dupReplaceSub:"××—×§ ×§×™×™×, ×©×™× ×—×“×© ×‘××§×•××•",
    dupAdd:"â•", dupAddDesc:"×”×•×¡×£ â€” ×›× ×¡×™×•×Ÿ × ×¤×¨×“", dupAddSub:"×©××•×¨ ××ª ×©× ×™×”×",
    dupApplyAll:"×”×—×œ ×¢×œ ×›×œ ×”×›×¤×•×œ×™×:", dupSkipAll:"â­ ×“×œ×’ ×œ×›×•×œ×", dupMergeAll:"ğŸ”€ ××–×’ ×”×›×œ", dupReplaceAll:"ğŸ” ×”×—×œ×£ ×”×›×œ",
    addLocation:"+ ×”×•×¡×£ ××™×§×•×",
  },
  en: {
    appName:"Experiment Manager", appSub:"Route Planning Experiment with AI",
    tabAssign:"ğŸ“‹ Assignments", tabCalendar:"ğŸ“… Calendar", tabCharts:"ğŸ“Š Charts",
    tabEmails:"âœ‰ï¸ Emails", tabLocations:"ğŸ“ Locations",
    btnLoad:"â†» Load", btnSave:"ğŸ’¾ Save", syncLocal:"Local", syncSaving:"...",
    completed:"Completed",
    statReg:"Registered", statAssigned:"Assigned", statConfirmed:"Confirmed", statDeclined:"Declined",
    btnAddParticipant:"+ Add Participant", btnAutoAssign:"âš¡ Auto-Assign All",
    btnAutoAssignSel:"âš¡ Assign Selected", btnClearAssign:"ğŸ—‘ Clear Assignments",
    btnExport:"â¬‡ï¸ Export", btnImportCSV:"ğŸ“‚ Import CSV", btnImportSheets:"ğŸ“‹ Import from Sheets",
    searchPlaceholder:"ğŸ” Search name / email", filterAssigned:"Assigned?",
    filterAll:"All", filterYes:"Assigned", filterNo:"Not assigned", clearAll:"âœ• Clear all",
    colName:"Name", colEmail:"Email", colAge:"Age", colGender:"Gender",
    colAvail:"Availability", colDay:"Day", colSlot:"Shift", colLocation:"Location",
    colRoom:"Room", colStatus:"Status", colLocPref:"Location Preference",
    colNotes:"Notes", colActions:"Actions",
    sortAsc:"â†‘ Ascending", sortDesc:"â†“ Descending", clearColFilter:"âœ• Clear column filter",
    statusPending:"Pending", statusAssigned:"Assigned", statusConfirmed:"Confirmed",
    statusCompleted:"Completed", statusDeclined:"Declined",
    dayA:"Sunday", dayB:"Monday", dayC:"Tuesday", dayD:"Wednesday", dayE:"Thursday", dayF:"Friday",
    dayPrefix:"",
    slotMorning:"Morning", slotAfternoon:"Afternoon",
    editParticipant:"Edit Participant", addParticipant:"Add Participant Manually",
    fieldName:"Full Name *", fieldEmail:"Email", fieldPhone:"Phone",
    fieldAge:"Age", fieldGender:"Gender", fieldStatus:"Status",
    fieldNotes:"Notes", fieldAvail:"Availability", fieldLocPref:"ğŸ“ Location Preference (multi-select)",
    genderM:"Male", genderF:"Female", genderO:"Other", genderPick:"Select",
    btnCancel:"Cancel", btnSaveChanges:"ğŸ’¾ Save Changes", btnAddConfirm:"âœ… Add Participant",
    available:"âœ“ Available", notAvailable:"â€”",
    noLocations:"No locations defined",
    menuHelp:"Help & Guide", menuChangelog:"Change Log",
    menuDark:"Dark Mode", menuLight:"Light Mode",
    menuGmail:"Gmail Settings", menuSettings:"Settings",
    menuAbout:"About", menuLang:"ğŸŒ ×¢×‘×¨×™×ª",
    emailManualTitle:"âœï¸ Custom Message to Participants",
    emailThanksTitle:"ğŸ™ Thank Completed Participants",
    btnSendThanks:"âœ‰ï¸ Send Thanks", btnSendThanksAll:"ğŸ“¨ Send Thanks to All",
    btnProofread:"âœï¸ Proofread (AI)", btnRewrite:"ğŸ”„ Rewrite (AI)",
    langWarning:"Note: Some content (names, availability) will remain in Hebrew",
    bulkLocPref:"ğŸ“ Preference:",
    settingsTitle:"âš™ï¸ Experiment Settings",
    dupTitle:"âš ï¸ Duplicate Found", dupOf:"of", dupConflicts:"conflicts",
    dupFrom:"ğŸ“¥ From file (new)", dupExisting:"âœ… In system (existing)",
    dupFoundBy:"ğŸ” Matched by:",
    dupSkip:"â­", dupSkipDesc:"Skip â€” keep existing", dupSkipSub:"Ignore the new entry",
    dupMerge:"ğŸ”€", dupMergeDesc:"Merge â€” keep assignment", dupMergeSub:"Update availability & details",
    dupReplace:"ğŸ”", dupReplaceDesc:"Replace â€” use new data", dupReplaceSub:"Delete existing, use new",
    dupAdd:"â•", dupAddDesc:"Add â€” as separate", dupAddSub:"Keep both entries",
    dupApplyAll:"Apply to all duplicates:", dupSkipAll:"â­ Skip all", dupMergeAll:"ğŸ”€ Merge all", dupReplaceAll:"ğŸ” Replace all",
    addLocation:"+ Add Location",
  }
};

// â”€â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SK = "exp_v5";
const loadState = () => { try { const r = localStorage.getItem(SK); return r ? JSON.parse(r) : null; } catch { return null; } };
const saveState = (s) => { try { localStorage.setItem(SK, JSON.stringify(s)); } catch {} };

// â”€â”€â”€ Google Sheets Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Note: Claude artifacts block outbound fetch to external URLs.
// Sync works via copy/paste of JSON â€” paste into Sheets script manually,
// or deploy the app on Replit/Vercel for live sync.
const GS_URL = "https://script.google.com/macros/s/AKfycbzzJP566YX-Hsy5kwaOh1H6Vh_qfCtIALGj-8KxlhtTt0xKGOmcRmV3QmoKpllfCcfr/exec";

async function gsGetAll() {
  // Try fetch â€” will fail in artifact due to network policy
  const res = await fetch(`${GS_URL}?action=getAll`, { mode: "cors" });
  if (!res.ok) throw new Error("Network blocked");
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data;
}

async function gsSaveAll(payload) {
  const res = await fetch(GS_URL, {
    method: "POST",
    mode: "cors",
    headers: { "Content-Type": "text/plain" }, // avoid preflight
    body: JSON.stringify({ action: "saveAll", ...payload }),
  });
  if (!res.ok) throw new Error("Network blocked");
  const data = await res.json();
  if (data.error) throw new Error(data.error);
  return data;
}

async function gsUpdateP(id, patch, user) {
  const res = await fetch(GS_URL, {
    method: "POST",
    mode: "cors",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify({ action: "updateP", id, patch, user }),
  });
  if (!res.ok) throw new Error("Network blocked");
  return res.json();
}

// â”€â”€â”€ Seed data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED = [{"name":"×™×¨×™×‘ ××™×¦×§×•×‘×™×¥'","email":"Yarivitzko@gmail.com","phone":"0547829570","age":"29","gender":"×’×‘×¨","availability":{"×":[],"×‘":[],"×’":[],"×“":["×‘×•×§×¨ (08:00-12:00)"],"×”":[],"×•":[]}},{"name":"×“×•×“×• ×‘×—×‘×•×˜","email":"Dudub987@gmail.com","phone":"0505949885","age":"26","gender":"×’×‘×¨","availability":{"×":[],"×‘":["×¦×”×¨×™×™× (12:00-18:00)"],"×’":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":[]}},{"name":"××•×—××“ ×©×œ××¢×˜×”","email":"mshalata79@gmail.com","phone":"0547425877","age":"24","gender":"×’×‘×¨","availability":{"×":[],"×‘":[],"×’":[],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":[]}},{"name":"×¨×™×× ×—× ×’×¨","email":"reema.kh99@gmail.com","phone":"0547972793","age":"22","gender":"××™×©×”","availability":{"×":[],"×‘":["×¦×”×¨×™×™× (12:00-18:00)"],"×’":["×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":[],"×•":[]}},{"name":"×—×Ÿ ×”×•×›×©×˜×˜","email":"chen100h@gmail.com","phone":"0542863524","age":"34","gender":"×’×‘×¨","availability":{"×":[],"×‘":[],"×’":[],"×“":[],"×”":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×•":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"]}},{"name":"×©×¨×” ××’×‘×¨×™×”","email":"Ag.saraosh@gmail.com","phone":"0549939105","age":"24","gender":"××™×©×”","availability":{"×":[],"×‘":[],"×’":["×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":[]}},{"name":"× ×’×” ×”×¨×¨×™","email":"Nogush212@gmail.com","phone":"052-3262666","age":"26","gender":"××™×©×”","availability":{"×":[],"×‘":[],"×’":["×¦×”×¨×™×™× (12:00-18:00)"],"×“":[],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":[]}},{"name":"×¨× ×ª ×§×¨×™××•×‘","email":"Karmant8@gmail.com","phone":"0549409320","age":"35","gender":"×’×‘×¨","availability":{"×":["×¦×”×¨×™×™× (12:00-18:00)"],"×‘":[],"×’":[],"×“":[],"×”":["×‘×•×§×¨ (08:00-12:00)"],"×•":["×¦×”×¨×™×™× (12:00-18:00)"]}},{"name":"×“×¨×™×” ×’×œ×™×§××Ÿ","email":"","phone":"0528759788","age":"25","gender":"××™×©×”","availability":{"×":["×¦×”×¨×™×™× (12:00-18:00)"],"×‘":["×¦×”×¨×™×™× (12:00-18:00)"],"×’":[],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":[]}},{"name":"××œ×™×¡×” ×§×•×œ×¡× ×™×§","email":"kolesnikalisa29@gmail.com","phone":"0559635724","age":"28","gender":"××™×©×”","availability":{"×":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×‘":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×’":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×•":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"]}},{"name":"×’××•×¨×’×™ ×“×•×¨×•×’×•×™","email":"gdorogoy@gmail.com","phone":"0586838206","age":"19","gender":"×’×‘×¨","availability":{"×":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×‘":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×’":[],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":["×‘×•×§×¨ (08:00-12:00)"]}},{"name":"× ×•×¨ ××“×‘×™×”","email":"Nouredbia@gmail.com","phone":"058-7676773","age":"26","gender":"××™×©×”","availability":{"×":["×¦×”×¨×™×™× (12:00-18:00)"],"×‘":["×‘×•×§×¨ (08:00-12:00)"],"×’":["×‘×•×§×¨ (08:00-12:00)"],"×“":["×‘×•×§×¨ (08:00-12:00)"],"×”":["×‘×•×§×¨ (08:00-12:00)"],"×•":["×‘×•×§×¨ (08:00-12:00)"]}},{"name":"×¨××™×” ×–×•×‘×™×“××ª","email":"raya.zubidat2002@gmail.com","phone":"0522096678","age":"23","gender":"××™×©×”","availability":{"×":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×‘":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×’":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×•":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"]}},{"name":"×©××“×” ×¢×™×¡××•×•×™","email":"esawishada@gmail.com","phone":"0584886401","age":"22","gender":"××™×©×”","availability":{"×":["×‘×•×§×¨ (08:00-12:00)"],"×‘":["×‘×•×§×¨ (08:00-12:00)"],"×’":["×‘×•×§×¨ (08:00-12:00)"],"×“":["×‘×•×§×¨ (08:00-12:00)"],"×”":["×‘×•×§×¨ (08:00-12:00)"],"×•":[]}},{"name":"×”×™×œ×” ×©×§","email":"hillashek@gmail.com","phone":"0546444179","age":"23","gender":"××™×©×”","availability":{"×":[],"×‘":[],"×’":[],"×“":[],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":[]}},{"name":"×“× ×™××œ ×¤×™×™×’×¨","email":"daniellefaiger@gmail.com","phone":"0533356876","age":"21","gender":"××™×©×”","availability":{"×":[],"×‘":[],"×’":[],"×“":[],"×”":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"],"×•":["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"]}},{"name":"××œ×× ×™×•×¡×£","email":"ay1260127@gmail.com","phone":"0522201826","age":"22","gender":"××™×©×”","availability":{"×":[],"×‘":["×¦×”×¨×™×™× (12:00-18:00)"],"×’":["×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":[],"×•":[]}},{"name":"×œ×™××Ÿ ×˜×¨×‘×™×”","email":"Layan.tarabeih@gmail.com","phone":"0505990406","age":"23","gender":"××™×©×”","availability":{"×":["×¦×”×¨×™×™× (12:00-18:00)"],"×‘":["×¦×”×¨×™×™× (12:00-18:00)"],"×’":[],"×“":[],"×”":[],"×•":["×‘×•×§×¨ (08:00-12:00)"]}},{"name":"×›×¨××œ ×‘×¨","email":"Carmel2882@gmail.com","phone":"0548103777","age":"32","gender":"××™×©×”","availability":{"×":[],"×‘":[],"×’":["×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":["×‘×•×§×¨ (08:00-12:00)"]}},{"name":"××œ×Ÿ ×•×•×§×¨","email":"ajwecker@gmail.com","phone":"0546476275","age":"65","gender":"×’×‘×¨","availability":{"×":[],"×‘":[],"×’":["×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":[],"×•":[]}},{"name":"×¢×™×“×Ÿ ×”×œ×¤×¨×Ÿ","email":"idanhalpern@gmail.com","phone":"0526708800","age":"23","gender":"×’×‘×¨","availability":{"×":["×¦×”×¨×™×™× (12:00-18:00)"],"×‘":["×¦×”×¨×™×™× (12:00-18:00)"],"×’":["×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":[]}},{"name":"××œ××§ ×“×¨××•×©×”","email":"mlkdrr7@icloud.com","phone":"0547419334","age":"21","gender":"××™×©×”","availability":{"×":["×¦×”×¨×™×™× (12:00-18:00)"],"×‘":["×¦×”×¨×™×™× (12:00-18:00)"],"×’":["×¦×”×¨×™×™× (12:00-18:00)"],"×“":["×¦×”×¨×™×™× (12:00-18:00)"],"×”":["×¦×”×¨×™×™× (12:00-18:00)"],"×•":["×¦×”×¨×™×™× (12:00-18:00)"]}}];

// â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DAYS = ["×","×‘","×’","×“","×”","×•"];
const DAY_NAMES = {"×":"×¨××©×•×Ÿ","×‘":"×©× ×™","×’":"×©×œ×™×©×™","×“":"×¨×‘×™×¢×™","×”":"×—××™×©×™","×•":"×©×™×©×™"};
const SLOTS = ["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"];
const DAY_SUB = {"×":"×™×•× ×","×‘":"×™×•× ×‘","×’":"×™×•× ×’","×“":"×™×•× ×“","×”":"×™×•× ×”","×•":"×™×•× ×•"};
const HEBREW_MONTHS = ["×™× ×•××¨","×¤×‘×¨×•××¨","××¨×¥","××¤×¨×™×œ","×××™","×™×•× ×™","×™×•×œ×™","××•×’×•×¡×˜","×¡×¤×˜××‘×¨","××•×§×˜×•×‘×¨","× ×•×‘××‘×¨","×“×¦××‘×¨"];

const STATUS_COLORS = {
  pending:   { dot:"#4B6BFB", bg:"#F0F4FF", text:"#4B6BFB", border:"#C7D4FF" },
  assigned:  { dot:"#059669", bg:"#ECFDF5", text:"#059669", border:"#A7F3D0" },
  confirmed: { dot:"#D97706", bg:"#FFF7ED", text:"#D97706", border:"#FDE68A" },
  completed: { dot:"#6B7280", bg:"#F3F4F6", text:"#374151", border:"#D1D5DB" },
  declined:  { dot:"#DC2626", bg:"#FEF2F2", text:"#DC2626", border:"#FECACA" },
};
// Static STATUS_META (Hebrew) used for non-component contexts
const STATUS_META = {
  pending:   { label:"×××ª×™×Ÿ",  ...STATUS_COLORS.pending },
  assigned:  { label:"×©×•×‘×¥",   ...STATUS_COLORS.assigned },
  confirmed: { label:"××™×©×¨",   ...STATUS_COLORS.confirmed },
  completed: { label:"×”×©×œ×™×", ...STATUS_COLORS.completed },
  declined:  { label:"×‘×™×˜×œ",  ...STATUS_COLORS.declined },
};
const LOC_COLORS = [
  {bg:"#EEF2FF",text:"#4338CA",border:"#C7D4FF",dot:"#4338CA",chart:"#4338CA"},
  {bg:"#FFF7ED",text:"#C2410C",border:"#FED7AA",dot:"#EA580C",chart:"#EA580C"},
  {bg:"#F0FDF4",text:"#166534",border:"#A7F3D0",dot:"#16A34A",chart:"#16A34A"},
  {bg:"#FDF4FF",text:"#7E22CE",border:"#E9D5FF",dot:"#9333EA",chart:"#9333EA"},
];

// â”€â”€â”€ Dark mode tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const THEME = {
  light: {
    bg:"#F7F8FC", surface:"#FFFFFF", border:"#E5E7EB", text:"#1A1D2E",
    textMuted:"#6B7280", textFaint:"#9CA3AF", headerBg:"linear-gradient(135deg,#1E1B4B,#312E81,#4338CA)",
    rowEven:"#FFFFFF", rowOdd:"#EEF0F8", rowSel:"#EDE9FE", inputBg:"#FFFFFF",
    tablehead:"#F8F9FF", accent:"#4338CA",
  },
  dark: {
    bg:"#0F1117", surface:"#1E2130", border:"#2D3148", text:"#E8EAFF",
    textMuted:"#8B92C0", textFaint:"#555D85", headerBg:"linear-gradient(135deg,#0A0820,#13103A,#1D1880)",
    rowEven:"#1A1E2E", rowOdd:"#13162A", rowSel:"#252A45", inputBg:"#252A45",
    tablehead:"#181C2B", accent:"#7C82FF",
  }
};

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const norm = s => (s||"").toLowerCase().replace(/[-\s]/g,"");
const dupReason = (a,b) => {
  if(a.email && norm(a.email)===norm(b.email)) return "××™××™×™×œ";
  if(a.phone && a.phone.length>5 && norm(a.phone)===norm(b.phone)) return "×˜×œ×¤×•×Ÿ";
  if(norm(a.name)===norm(b.name) && a.name.length>1) return "×©×";
  return null;
};
const fmtDate = d => `${d.getDate()}/${d.getMonth()+1}`;
const tsToStr = ts => { const d=new Date(ts); return `${d.getDate()}/${d.getMonth()+1} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`; };
const newId = arr => Math.max(0,...arr.map(x=>x.id||0))+1;

function parseCSVRows(text) {
  // Handle quoted fields properly
  const rows = [];
  const lines = text.split(/\r?\n/).filter(Boolean);
  if(lines.length < 2) return [];
  
  function parseLine(line) {
    const result = [];
    let cur = "", inQ = false;
    for(let i = 0; i < line.length; i++) {
      const c = line[i];
      if(c === '"' && !inQ) { inQ = true; }
      else if(c === '"' && inQ && line[i+1] === '"') { cur += '"'; i++; }
      else if(c === '"' && inQ) { inQ = false; }
      else if(c === ',' && !inQ) { result.push(cur.trim()); cur = ""; }
      else { cur += c; }
    }
    result.push(cur.trim());
    return result;
  }
  
  const headers = parseLine(lines[0]);
  return lines.slice(1).map(line => {
    const vals = parseLine(line);
    const obj = {};
    headers.forEach((h, i) => obj[h.trim()] = (vals[i] || "").trim());
    return obj;
  });
}

function parseRow(row, id) {
  // Normalize a string: remove spaces, brackets, apostrophes â†’ for fuzzy matching
  const norm = s => s.replace(/\s+/g,"").replace(/[\[\]'×´×³]/g,"");

  // Find column value by partial normalized match
  const g = s => {
    const sn = norm(s);
    const key = Object.keys(row).find(k => norm(k).includes(sn));
    return key ? (row[key] || "").toString().trim() : "";
  };

  // Availability: match columns containing [×™×•× X'] or ×™×•× X
  // Google Form columns look like: "×–××™× ×•×ª ×œ×”×’×¢×” ×œ×§××¤×•×¡ ×”× ××œ   [×™×•× ×']"
  // Internal columns look like: "×™×•× ×"
  const DAY_MARKERS = {
    "×": ["×™×•××"],
    "×‘": ["×™×•××‘"],
    "×’": ["×™×•××’"],
    "×“": ["×™×•××“"],
    "×”": ["×™×•××”"],
    "×•": ["×™×•××•"],
  };
  const avail = {};
  DAYS.forEach(d => {
    const markers = DAY_MARKERS[d];
    const key = Object.keys(row).find(k => {
      const kn = norm(k);
      return markers.some(m => kn.includes(m));
    });
    const raw = key ? (row[key] || "").toString().trim() : "";
    // Values can be comma-separated: "×‘×•×§×¨ (08:00-12:00), ×¦×”×¨×™×™× (12:00-18:00)"
    avail[d] = raw ? raw.split(",").map(x => x.trim()).filter(x =>
      x === "×‘×•×§×¨ (08:00-12:00)" || x === "×¦×”×¨×™×™× (12:00-18:00)"
    ) : [];
  });

  // Extra fields from Google Form â€” store as notes
  const eligible = g("××¢×œ×’×™×œ18") || g("×”×™× ×š××¢×œ");
  const license  = g("×¨×™×©×™×•×Ÿ× ×”×™×’×”");
  const vision   = g("×”×¦×”×¨×ª×¨××™×™×”");
  const extraNote = [
    eligible === "×›×Ÿ" ? "" : eligible ? `×’×™×œ 18: ${eligible}` : "",
    license  === "×›×Ÿ" ? "" : license  ? `×¨×™×©×™×•×Ÿ: ${license}`  : "",
    vision && !vision.includes("×ª×§×™×Ÿ") ? `×¨××™×™×”: ${vision.substring(0,30)}` : "",
  ].filter(Boolean).join(" | ");

  return {
    id,
    name:   g("×©×××œ×") || g("×©×"),
    email:  g("×›×ª×•×‘×ª××™××™×™×œ") || g("××™××™×™×œ") || g("email"),
    phone:  g("××¡×¤×¨×˜×œ×¤×•×Ÿ") || g("×˜×œ×¤×•×Ÿ"),
    age:    g("×’×™×œ"),
    gender: g("××’×“×¨"),
    availability: avail,
    assigned: null,
    status: "pending",
    notes: extraNote,
    locPref: [],
    importedAt: Date.now(),
  };
}
function exportCSV(rows,filename) {
  if(!rows.length) return;
  const headers=Object.keys(rows[0]);
  const csv=[headers.join(","),...rows.map(r=>headers.map(h=>`"${(r[h]||"").toString().replace(/"/g,'""')}"`).join(","))].join("\n");
  const dataUri="data:text/csv;charset=utf-8,\uFEFF"+encodeURIComponent(csv);
  const a=document.createElement("a");
  a.href=dataUri;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Empty participant template
const emptyP = () => ({
  id:null,name:"",email:"",phone:"",age:"",gender:"",
  availability:{×:[],×‘:[],×’:[],×“:[],×”:[],×•:[]},
  assigned:null,status:"pending",notes:"",importedAt:Date.now()
});

// â”€â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const saved = loadState();
  const [participants,setParticipants] = useState(()=>saved?.participants||SEED.map((p,i)=>({...p,id:i,assigned:null,status:"pending",notes:"",importedAt:0})));
  const [locations,setLocations]       = useState(()=>saved?.locations||[{id:1,name:"× ××œ",rooms:["×›×™×ª×” ×","×›×™×ª×” ×‘"]},{id:2,name:"×”×¨",rooms:["×—×“×¨ 1"]}]);
  const [settings,setSettings]         = useState(()=>saved?.settings||{perSlot:1,maxPerDay:6,totalTarget:30,experimentName:"× ×™×¡×•×™ ×ª×›× ×•×Ÿ ××¡×œ×•×œ × ×¡×™×¢×” ×¢× AI",researcherName:"×”×—×•×§×¨",duration:"90 ×“×§×•×ª",baseDate:new Date().toISOString().split("T")[0],gmailToken:"",currentUser:"×—×•×§×¨ 1"});
  const [changelog,setChangelog]       = useState(()=>saved?.changelog||[]);
  const [darkMode,setDarkMode]         = useState(()=>saved?.darkMode||false);
  const [lang,setLang]                 = useState(()=>saved?.lang||"he");
  const L = (key) => LANG[lang]?.[key] ?? LANG.he[key] ?? key;
  const [history,setHistory] = useState([]);
  const [future,setFuture]   = useState([]);
  const [undoLabel,setUndoLabel] = useState(null);
  const [redoLabel,setRedoLabel] = useState(null);

  // Wrap setParticipants to snapshot for undo
  const setParticipantsUndo = (updater, label) => {
    setHistory(h=>[...h.slice(-29),{participants, label}]);
    setFuture([]);
    setUndoLabel(label||null);
    setRedoLabel(null);
    setParticipants(updater);
  };
  const undo = () => {
    if(!history.length) return;
    const prev=history[history.length-1];
    setFuture(f=>[{participants,label:undoLabel},...f.slice(0,29)]);
    setParticipants(prev.participants);
    setHistory(h=>h.slice(0,-1));
    setUndoLabel(history[history.length-2]?.label||null);
    setRedoLabel(undoLabel);
    showToast(`â†© ${lang==="en"?"Undone":"×‘×•×˜×œ"}: ${prev.label||""}`);
  };
  const redo = () => {
    if(!future.length) return;
    const next=future[0];
    setHistory(h=>[...h,{participants,label:redoLabel}]);
    setParticipants(next.participants);
    setFuture(f=>f.slice(1));
    setUndoLabel(redoLabel);
    setRedoLabel(future[1]?.label||null);
    showToast(`â†ª ${lang==="en"?"Redone":"×”×•×—×–×¨"}: ${next.label||""}`);
  };

  // Dynamic status labels using L()
  const statusMeta = useMemo(()=>({
    pending:   { label:L("statusPending"),  ...STATUS_COLORS.pending },
    assigned:  { label:L("statusAssigned"), ...STATUS_COLORS.assigned },
    confirmed: { label:L("statusConfirmed"),...STATUS_COLORS.confirmed },
    completed: { label:L("statusCompleted"),...STATUS_COLORS.completed },
    declined:  { label:L("statusDeclined"), ...STATUS_COLORS.declined },
  }),[lang]);

  // Dynamic day names using L()
  const dayNames = useMemo(()=>({
    "×":L("dayA"),"×‘":L("dayB"),"×’":L("dayC"),"×“":L("dayD"),"×”":L("dayE"),"×•":L("dayF")
  }),[lang]);

  // â”€â”€ Sync state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const [syncStatus,setSyncStatus] = useState("idle"); // idle | syncing | ok | error
  const [importStatus,setImportStatus] = useState(null); // null | {state:"loading"|"ok"|"error", msg:string}
  const [syncMsg,setSyncMsg]       = useState("");
  const [lastSync,setLastSync]     = useState(null);
  const syncTimerRef               = useRef(null);

  // UI state
  const [tab,setTab]             = useState("assignments");
  const [menuOpen,setMenuOpen]   = useState(false);
  const [modal,setModal]         = useState(null); // "help"|"about"|"changelog"|"settings"|"gmail"|"addEdit"
  const [editP,setEditP]         = useState(null); // participant being added/edited
  const [selected,setSelected]   = useState(new Set());
  const [sortCol,setSortCol]     = useState("name");
  const [sortDir,setSortDir]     = useState("asc");
  const [filters,setFilters]     = useState({name:"",status:[],location:[],day:[],gender:[],assigned:"",slot:[],locPref:[],age:[]});
  const [colMenu,setColMenu]       = useState(null); // {col, x, y}
  const [rowEmailMenu,setRowEmailMenu] = useState(null); // {pid, x, y}
  const [emailModal,setEmailModal] = useState(null);
  const [toast,setToast]           = useState(null);
  const [dupModal,setDupModal]     = useState(null);
  const [exportMenu,setExportMenu] = useState(false);
  const [bulkEmailOpen,setBulkEmailOpen] = useState(false);
  const [chartFilter,setChartFilter] = useState({status:"",location:""});
  const [weekOffset,setWeekOffset] = useState(0);
  const [calMode,setCalMode]       = useState("week");
  const [calMonth,setCalMonth]     = useState(()=>{const n=new Date();return{y:n.getFullYear(),m:n.getMonth()};});
  const [gmailConnected,setGmailConnected] = useState(false);
  const fileRef = useRef();

  const T = darkMode ? THEME.dark : THEME.light;

  // Persist locally
  useEffect(()=>{saveState({participants,locations,settings,changelog,darkMode,lang});},[participants,locations,settings,changelog,darkMode,lang]);
  useEffect(()=>{
    document.documentElement.setAttribute("dir", lang==="en"?"ltr":"rtl");
    document.documentElement.setAttribute("lang", lang);
  },[lang]);

  // â”€â”€ Load from Sheets on startup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(()=>{
    setSyncStatus("syncing");setSyncMsg("×˜×•×¢×Ÿ ×-Google Sheets...");
    gsGetAll()
      .then(data=>{
        if(data.error) throw new Error(data.error);
        if(data.participants?.length) setParticipants(data.participants);
        if(data.locations?.length)    setLocations(data.locations);
        if(data.settings && Object.keys(data.settings).length) setSettings(s=>({...s,...data.settings}));
        if(data.researchers?.length)  ; // could store if needed
        setSyncStatus("ok");setSyncMsg("××¡×•× ×›×¨×Ÿ");setLastSync(new Date());
      })
      .catch(err=>{
        setSyncStatus("error");setSyncMsg("×œ× ××—×•×‘×¨ ×œ×©×™×˜×¡ â€” ×¢×•×‘×“ ××§×•××™×ª");
        console.warn("Sheets load failed:",err);
      });
  },[]);

  // â”€â”€ NO auto-save: Sheets is the database, never overwrite automatically â”€â”€â”€â”€â”€
  // Changes are pushed row-by-row via gsUpdateP (single participant updates only)
  // Full save only happens via the explicit "ğŸ’¾ ×©××•×¨ ×œ-Sheets" button

  const showToast=(msg,type="ok")=>{setToast({msg,type});setTimeout(()=>setToast(null),3000);};

  const locById = useMemo(()=>{const m={};locations.forEach(l=>m[l.id]=l);return m;},[locations]);
  const locColor = id=>LOC_COLORS[(locations.findIndex(l=>l.id===id)||0)%LOC_COLORS.length];

  // â”€â”€ Changelog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const addLog = useCallback((action,details)=>{
    const entry={id:Date.now(),ts:Date.now(),user:settings.currentUser,action,details};
    setChangelog(prev=>[entry,...prev].slice(0,500));
  },[settings.currentUser]);

  // â”€â”€ Participant mutations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const updP = useCallback((id,patch,logMsg)=>{
    setParticipantsUndo(prev=>prev.map(p=>p.id===id?{...p,...patch}:p), logMsg);
    if(logMsg) addLog("×¢×“×›×•×Ÿ",logMsg);
    // Push only this single row to Sheets (safe â€” never touches other rows)
    if(syncStatus!=="error") {
      gsUpdateP(id, patch, settings.currentUser)
        .then(()=>{setSyncStatus("ok");setSyncMsg("× ×©××¨");setLastSync(new Date());})
        .catch(()=>{setSyncStatus("error");setSyncMsg("×©×’×™××ª ×¢×“×›×•×Ÿ ×©×•×¨×”");});
    }
  },[addLog, settings.currentUser, syncStatus]);

  const assignP = (id,day,slot,locationId,room)=>{
    const p=participants.find(x=>x.id===id);
    updP(id,{assigned:{day,slot,locationId,room},status:"assigned"},`×©×™×‘×•×¥ ${p?.name} â† ×™×•× ${dayNames[day]} ${slot.includes("×‘×•×§×¨")?"×‘×•×§×¨":"×¦×”×¨×™×™×"} @ ${locById[locationId]?.name||""}`);
  };
  const clearA = id=>{
    const p=participants.find(x=>x.id===id);
    updP(id,{assigned:null,status:"pending"},`× ×™×§×•×™ ×©×™×‘×•×¥: ${p?.name}`);
  };

  // â”€â”€ Auto-assign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function autoAssign(ids) {
    const updated=participants.map(p=>({...p}));
    const cnt={};
    updated.filter(p=>p.assigned).forEach(p=>{const k=`${p.assigned.day}_${p.assigned.slot}_${p.assigned.locationId}`;cnt[k]=(cnt[k]||0)+1;});
    const queue=updated.filter(p=>(ids?ids.has(p.id):!p.assigned)&&Object.values(p.availability).some(s=>s.length>0))
      .sort((a,b)=>Object.values(a.availability).flat().length-Object.values(b.availability).flat().length);
    let n=0;
    queue.forEach(p=>{
      // Try preferred locations first, then all others
      const prefs=p.locPref&&p.locPref.length>0?p.locPref:[];
      const orderedLocs=[
        ...locations.filter(l=>prefs.includes(l.id)),
        ...locations.filter(l=>!prefs.includes(l.id)),
      ];
      outer:for(const day of DAYS){
        if(updated.filter(u=>u.assigned?.day===day).length>=settings.maxPerDay) continue;
        for(const slot of p.availability[day]||[]){
          for(const loc of orderedLocs){
            const k=`${day}_${slot}_${loc.id}`;
            if((cnt[k]||0)<settings.perSlot){
              const idx=updated.findIndex(u=>u.id===p.id);
              updated[idx].assigned={day,slot,locationId:loc.id,room:loc.rooms[0]||""};
              updated[idx].status="assigned";cnt[k]=(cnt[k]||0)+1;n++;break outer;
            }
          }
        }
      }
    });
    setParticipantsUndo(()=>updated, lang==="en"?"Auto-assign":"×©×™×‘×•×¥ ××•×˜×•××˜×™");
    addLog("×©×™×‘×•×¥ ××•×˜×•××˜×™",`×©×•×‘×¦×• ${n} ××©×ª×ª×¤×™×`);
    showToast(`âš¡ ×©×•×‘×¦×• ${n} ××©×ª×ª×¤×™×`);
  }

  // â”€â”€ Clear assignments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearAssignments(ids) {
    const count = ids ? ids.size : participants.filter(p=>p.assigned).length;
    if(!window.confirm(`×œ× ×§×•×ª ${count} ×©×™×‘×•×¦×™×?`)) return;
    setParticipants(prev=>prev.map(p=>(ids?ids.has(p.id):true)&&p.assigned?{...p,assigned:null,status:"pending"}:p));
    addLog("× ×™×§×•×™ ×©×™×‘×•×¦×™×",`× ×•×§×• ${count} ×©×™×‘×•×¦×™× ×¢"×™ ${settings.currentUser}`);
    showToast(`ğŸ—‘ × ×•×§×• ${count} ×©×™×‘×•×¦×™×`);
  }

  // â”€â”€ Add / Edit participant â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveParticipant(p) {
    if(!p.id) {
      const np={...p,id:newId(participants),importedAt:Date.now()};
      // Check for duplicates before adding
      const dups=participants.filter(ex=>dupReason(np,ex));
      if(dups.length>0) {
        setModal(null);setEditP(null);
        setDupModal({conflicts:[{incoming:np,existing:dups,reason:dupReason(np,dups[0])}],index:0,newOnes:[],resolved:[],onDone:(action)=>{
          if(action==="add"){setParticipants(prev=>[...prev,np]);addLog("×”×•×¡×¤×” ×™×“× ×™×ª",`× ×•×¡×£: ${np.name}`);}
          else if(action==="replace"){setParticipants(prev=>prev.map(q=>q.id===dups[0].id?{...np,id:q.id}:q));addLog("×”×—×œ×¤×” ×™×“× ×™×ª",`×”×•×—×œ×£: ${np.name}`);}
          else if(action==="merge"){setParticipants(prev=>prev.map(q=>q.id===dups[0].id?{...q,...np,id:q.id,assigned:q.assigned,status:q.status}:q));addLog("××™×–×•×’ ×™×“× ×™",`××•×–×’: ${np.name}`);}
          setModal(null);setEditP(null);
        }});
        return;
      }
      setParticipantsUndo(prev=>[...prev,np], `${lang==="en"?"Add":"×”×•×¡×£"}: ${np.name}`);
      addLog("×”×•×¡×¤×” ×™×“× ×™×ª",`× ×•×¡×£: ${np.name}`);
      showToast(`âœ… ${np.name} × ×•×¡×£`);
    } else {
      updP(p.id,p,`×¢×¨×™×›×”: ${p.name}`);
      showToast(`âœ… ${p.name} ×¢×•×“×›×Ÿ`);
    }
    setModal(null);setEditP(null);
  }

  // â”€â”€ CSV import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleFile(file) {
    setImportStatus({state:"loading", msg:"×§×•×¨× ××ª ×”×§×•×‘×¥..."});
    const reader=new FileReader();
    reader.onload=e=>{
      try {
        const rows=parseCSVRows(e.target.result);
        let nextId=newId(participants);
        const newOnes=[], conflicts=[];
        rows.forEach(row=>{
          const p=parseRow(row,nextId++);
          if(!p.name) return;
          const dups=participants.filter(ex=>dupReason(p,ex));
          if(dups.length>0) conflicts.push({incoming:p, existing:dups, reason:dupReason(p,dups[0])});
          else newOnes.push(p);
        });
        setImportStatus(null);
        // If all conflicts are seed data (importedAt===0), replace them silently
        const seedConflicts = conflicts.filter(c => c.existing[0].importedAt === 0);
        const realConflicts = conflicts.filter(c => c.existing[0].importedAt !== 0);
        
        let updatedParts = [...participants];
        // Auto-replace seed duplicates
        seedConflicts.forEach(({incoming, existing}) => {
          updatedParts = updatedParts.map(p => p.id===existing[0].id ? {...incoming, id:p.id} : p);
          newOnes.push(); // already handled
        });
        
        if(realConflicts.length > 0) {
          // Show modal only for real (non-seed) conflicts
          setParticipants(updatedParts);
          setDupModal({conflicts: realConflicts, index:0, newOnes, resolved:[]});
        } else {
          setParticipants([...updatedParts, ...newOnes]);
          addLog("×™×‘×•× CSV", `×™×•×‘××• ${newOnes.length} ×—×“×©×™×, ×¢×•×“×›× ×• ${seedConflicts.length} ×§×™×™××™×`);
          setImportStatus({state:"ok", msg:`âœ… ×™×•×‘××• ${newOnes.length + seedConflicts.length} ××©×ª×ª×¤×™×`});
          setTimeout(()=>setImportStatus(null), 4000);
        }
      } catch(err) {
        setImportStatus({state:"error", msg:`×©×’×™××”: ${err.message}`});
        setTimeout(()=>setImportStatus(null),5000);
      }
    };
    reader.onerror=()=>{
      setImportStatus({state:"error", msg:"×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥"});
      setTimeout(()=>setImportStatus(null),5000);
    };
    reader.readAsText(file,"UTF-8");
  }
  function resolveDup(action) {
    const {conflicts,index,newOnes,resolved}=dupModal;
    const {incoming,existing}=conflicts[index];
    const newR=[...resolved,{action,name:incoming.name,p:incoming}];
    if(action==="replace") setParticipants(prev=>prev.map(p=>p.id===existing[0].id?{...incoming,id:p.id,assigned:p.assigned,status:p.status}:p));
    else if(action==="merge") setParticipants(prev=>prev.map(p=>p.id===existing[0].id?{...p,availability:incoming.availability,email:incoming.email||p.email}:p));
    const next=index+1;
    if(next<conflicts.length){setDupModal({...dupModal,index:next,resolved:newR});return;}
    // If this was a manual-add dup check, call onDone callback
    if(dupModal.onDone) {
      setDupModal(null);
      dupModal.onDone(action);
      return;
    }
    const toAdd=[...newOnes,...newR.filter(r=>r.action==="add").map(r=>r.p)];
    setParticipants(prev=>[...prev,...toAdd]);
    setDupModal(null);
    const merged=newR.filter(r=>r.action==="merge").length;
    const replaced=newR.filter(r=>r.action==="replace").length;
    const skipped=newR.filter(r=>r.action==="skip").length;
    addLog("×™×‘×•× CSV",`× ×•×¡×¤×• ${toAdd.length}, ××•×–×’×• ${merged}, ×”×•×—×œ×¤×• ${replaced}`);
    setImportStatus({state:"ok", msg:`âœ… × ×•×¡×¤×• ${toAdd.length} | ××•×–×’×• ${merged} | ×”×•×—×œ×¤×• ${replaced} | ×“×•×œ×’×• ${skipped}`});
    setTimeout(()=>setImportStatus(null),5000);
  }

  // â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function doExport(field) {
    const list=selected.size>0?participants.filter(p=>selected.has(p.id)):participants;
    const map={
      all: p=>({×©×:p.name,××™××™×™×œ:p.email||"",×˜×œ×¤×•×Ÿ:p.phone||"",×’×™×œ:p.age||"",××’×“×¨:p.gender||"",×™×•×:p.assigned?dayNames[p.assigned.day]:"",××©××¨×ª:p.assigned?.slot||"",××™×§×•×:p.assigned?locById[p.assigned.locationId]?.name||"":"",×—×“×¨:p.assigned?.room||"",×¡×˜×˜×•×¡:statusMeta[p.status].label,×”×¢×¨×•×ª:p.notes||""}),
      email: p=>({×©×:p.name,××™××™×™×œ:p.email||""}),
      phone: p=>({×©×:p.name,×˜×œ×¤×•×Ÿ:p.phone||""}),
    };
    exportCSV(list.map(map[field]),`${field}_export.csv`);
    setExportMenu(false);
  }
  function doExportJSON() {
    const json=JSON.stringify({participants,locations,settings,changelog},null,2);
    const dataUri="data:application/json;charset=utf-8,"+encodeURIComponent(json);
    const a=document.createElement("a");
    a.href=dataUri;
    a.download="experiment_backup.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast("âœ… JSON exported");
  }

  // â”€â”€ Sort & filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sortedFiltered = useMemo(()=>{
    let list=[...participants].filter(p=>{
      if(filters.name && !p.name.includes(filters.name) && !(p.email||"").includes(filters.name)) return false;
      if(filters.assigned==="yes" && !p.assigned) return false;
      if(filters.assigned==="no" && p.assigned) return false;
      if(filters.status.length>0 && !filters.status.includes(p.status)) return false;
      if(filters.gender.length>0 && !filters.gender.includes(p.gender||"")) return false;
      if(filters.location.length>0 && !filters.location.includes(String(p.assigned?.locationId||""))) return false;
      if(filters.day.length>0 && !filters.day.includes(p.assigned?.day||"")) return false;
      if(filters.slot.length>0 && !filters.slot.some(s=>
        (p.assigned?.slot||"").includes(s)||Object.values(p.availability||{}).flat().some(a=>a.includes(s))
      )) return false;
      if(filters.locPref.length>0 && !filters.locPref.some(lp=>(p.locPref||[]).map(String).includes(String(lp)))) return false;
      if(filters.age.length>0 && !filters.age.includes(String(p.age||""))) return false;
      return true;
    });
    list.sort((a,b)=>{
      let va=a[sortCol]||"", vb=b[sortCol]||"";
      if(sortCol==="age") {va=parseInt(va)||0;vb=parseInt(vb)||0;return sortDir==="asc"?va-vb:vb-va;}
      va=va.toString().toLowerCase();vb=vb.toString().toLowerCase();
      return sortDir==="asc"?va.localeCompare(vb,"he"):vb.localeCompare(va,"he");
    });
    return list;
  },[participants,filters,sortCol,sortDir]);

  const toggleSort = col=>{if(sortCol===col)setSortDir(d=>d==="asc"?"desc":"asc");else{setSortCol(col);setSortDir("asc");}};
  const SortIcon = ({col})=>sortCol===col?<span style={{fontSize:10,marginRight:2}}>{sortDir==="asc"?"â†‘":"â†“"}</span>:<span style={{fontSize:10,marginRight:2,opacity:0.3}}>â†•</span>;

  // â”€â”€ Selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const toggleSel = id=>{setSelected(prev=>{const n=new Set(prev);n.has(id)?n.delete(id):n.add(id);return n;});};
  const selList = participants.filter(p=>selected.has(p.id));
  const selHasAssigned = selList.some(p=>p.assigned);
  const selCanAutoAssign = selList.some(p=>!p.assigned&&Object.values(p.availability).some(s=>s.length>0));

  // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const stats = useMemo(()=>{
    let src=participants;
    if(chartFilter.status) src=src.filter(p=>p.status===chartFilter.status);
    if(chartFilter.location) src=src.filter(p=>p.assigned?.locationId===parseInt(chartFilter.location));
    const byStatus={};Object.keys(statusMeta).forEach(s=>byStatus[s]=0);
    participants.forEach(p=>byStatus[p.status]=(byStatus[p.status]||0)+1);
    const byDay=DAYS.map(d=>({day:dayNames[d],count:src.filter(p=>p.assigned?.day===d).length}));
    const byLoc=locations.map(l=>({name:l.name,count:src.filter(p=>p.assigned?.locationId===l.id).length}));
    const byGender=[{name:"×’×‘×¨",count:src.filter(p=>p.gender==="×’×‘×¨").length},{name:"××™×©×”",count:src.filter(p=>p.gender==="××™×©×”").length}];
    return{byStatus,byDay,byLoc,byGender,noAvail:participants.filter(p=>Object.values(p.availability).every(s=>s.length===0)).length,total:participants.length};
  },[participants,locations,chartFilter]);

  // â”€â”€ Email builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildEmail(p,type="invitation") {
    const loc=p.assigned?(locById[p.assigned.locationId]?.name||""):"";
    const room=p.assigned?.room||"";
    const day=p.assigned?`×™×•× ${dayNames[p.assigned.day]}`:"â€”";
    const slot=p.assigned?p.assigned.slot.replace("×‘×•×§×¨ (08:00-12:00)","08:00â€“12:00").replace("×¦×”×¨×™×™× (12:00-18:00)","12:00â€“18:00"):"â€”";
    if(type==="invitation") return{subject:`×”×–×× ×” ×œ× ×™×¡×•×™ â€“ ${settings.experimentName}`,body:`×©×œ×•× ${p.name},\n\n×©××—× ×• ×œ×”×–××™×Ÿ ××•×ª×š ×œ× ×™×¡×•×™ "${settings.experimentName}"!\n\nğŸ“… ×™×•×: ${day}\nâ° ×©×¢×•×ª: ${slot}\nğŸ“ ××™×§×•×: ${loc}${room?` â€“ ${room}`:""}\nâ± ××©×š: ${settings.duration}\n\n×× × ××©×¨/×™ ×”×’×¢×” ×‘××¢× ×” ×œ××™×™×œ ×–×”.\n\n×‘×‘×¨×›×”,\n${settings.researcherName}`};
    if(type==="reminder") return{subject:`×ª×–×›×•×¨×ª â€“ ${settings.experimentName}`,body:`×©×œ×•× ${p.name},\n\n×ª×–×›×•×¨×ª: ${day} | ${slot} | ${loc}${room?` â€“ ${room}`:""}\n\n××—×›×™× ×œ×¨××•×ª×š!\n\n×‘×‘×¨×›×”,\n${settings.researcherName}`};
    return{subject:`×¢×“×›×•×Ÿ ×–××™× ×•×ª â€“ ${settings.experimentName}`,body:`×©×œ×•× ${p.name},\n\n×œ× ××¦×× ×• ×–××Ÿ ××ª××™×. ×”×× ×ª×•×›×œ/×™ ×œ×¢×“×›×Ÿ ×™××™× × ×•×¡×¤×™×?\n\n×‘×‘×¨×›×”,\n${settings.researcherName}`};
  }

  // â”€â”€ Gmail OAuth (mailto fallback in artifact) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sendViaGmail(subject,body,to) {
    // In an artifact we cannot use OAuth directly â€” we open Gmail compose with prefill
    window.open(`https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`,"_blank");
    addLog("××™×™×œ",`× ×©×œ×— ××™×™×œ ×œ: ${to}`);
  }

  // â”€â”€ Calendar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function getWeekDates(offset) {
    const base=new Date(settings.baseDate);
    base.setDate(base.getDate()+offset*7);
    const day=base.getDay();
    const sun=new Date(base);sun.setDate(base.getDate()-day);
    return Array.from({length:6},(_,i)=>{const x=new Date(sun);x.setDate(sun.getDate()+i);return x;});
  }
  const weekDates=useMemo(()=>getWeekDates(weekOffset),[weekOffset,settings.baseDate]);

  // â”€â”€ CSS vars via style tag â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const baseStyle={fontFamily:"Arial,sans-serif",background:T.bg,height:"100vh",display:"flex",flexDirection:"column",overflow:"hidden",color:T.text,transition:"background .3s,color .3s"};

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  return (
    <div dir={lang==="en"?"ltr":"rtl"} style={baseStyle} onClick={()=>{setMenuOpen(false);setExportMenu(false);setBulkEmailOpen(false);setRowEmailMenu(null);setColMenu(null);}}>


      {/* â”€â”€ Header â”€â”€ */}
      <div style={{background:T.headerBg,padding:"8px 22px",color:"white",position:"sticky",top:0,zIndex:50,boxShadow:"0 2px 12px rgba(0,0,0,0.3)"}}>
        <div style={{maxWidth:1500,margin:"0 auto",display:"flex",justifyContent:"space-between",alignItems:"center",gap:10}}>

          {/* LEFT: Hamburger + title */}
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <div style={{position:"relative"}}>
              <button onClick={e=>{e.stopPropagation();setMenuOpen(v=>!v);}} style={{background:"rgba(255,255,255,0.15)",border:"none",color:"white",borderRadius:7,padding:"5px 9px",cursor:"pointer",fontSize:16,lineHeight:1}}>â˜°</button>
              {menuOpen&&(
                <div onClick={e=>e.stopPropagation()} style={{position:"absolute",top:"110%",[lang==="en"?"left":"right"]:0,background:T.surface,border:`1px solid ${T.border}`,borderRadius:10,boxShadow:"0 12px 40px rgba(0,0,0,0.2)",zIndex:200,minWidth:200,overflow:"hidden"}}>
                  {[
                    {icon:"ğŸ“–",label:L("menuHelp"),action:()=>{setModal("help");setMenuOpen(false);}},
                    {icon:"ğŸ“‹",label:L("menuChangelog"),action:()=>{setModal("changelog");setMenuOpen(false);}},
                    {icon:darkMode?"â˜€ï¸":"ğŸŒ™",label:darkMode?L("menuLight"):L("menuDark"),action:()=>{setDarkMode(v=>!v);setMenuOpen(false);}},
                    {icon:"âœ‰ï¸",label:L("menuGmail"),action:()=>{setModal("gmail");setMenuOpen(false);}},
                    {icon:"âš™ï¸",label:L("menuSettings"),action:()=>{setModal("settings");setMenuOpen(false);}},
                    {icon:"ğŸŒ",label:lang==="he"?"English":"×¢×‘×¨×™×ª",action:()=>{
                      const next=lang==="he"?"en":"he";
                      setLang(next);setMenuOpen(false);
                      showToast(next==="en"?"ğŸŒ Switched to English â€” names & availability stay in Hebrew":"ğŸŒ ×¢×‘×¨×” ×œ×¢×‘×¨×™×ª");
                    }},
                    {icon:"â„¹ï¸",label:L("menuAbout"),action:()=>{setModal("about");setMenuOpen(false);}},
                  ].map(item=>(
                    <button key={item.label} onClick={item.action} style={{display:"flex",alignItems:"center",gap:10,width:"100%",textAlign:"start",padding:"11px 16px",border:"none",background:"none",cursor:"pointer",fontSize:13,fontFamily:"inherit",color:T.text,borderBottom:`1px solid ${T.border}`}}>
                      <span>{item.icon}</span>{item.label}
                    </button>
                  ))}
                </div>
              )}
            </div>
            <div>
              <h1 style={{margin:0,fontSize:15,fontWeight:800,lineHeight:1,fontFamily:"Arial,sans-serif"}}>{L("appName")}</h1>
              <p style={{margin:0,opacity:0.55,fontSize:10,marginTop:2}}>{settings.experimentName}</p>
            </div>
          </div>

          {/* CENTER: completed progress */}
          <div style={{display:"flex",flexDirection:"column",alignItems:"center",gap:2}}>
            <div style={{fontSize:22,fontWeight:900,lineHeight:1,letterSpacing:"-0.5px"}}>
              {stats.byStatus.completed}<span style={{fontSize:13,opacity:0.6,fontWeight:400}}>/{settings.totalTarget}</span>
            </div>
            <div style={{fontSize:9,opacity:0.6,letterSpacing:"0.5px",textTransform:"uppercase"}}>{L("completed")}</div>
            <div style={{background:"rgba(255,255,255,0.2)",borderRadius:3,height:3,width:70}}>
              <div style={{background:"#34D399",height:3,borderRadius:3,width:`${Math.min(100,stats.byStatus.completed/settings.totalTarget*100)}%`,transition:"width .5s"}}/>
            </div>
          </div>

          {/* RIGHT: sync controls */}
          <div style={{display:"flex",alignItems:"center",gap:5}}>
            <span style={{fontSize:10,color:"rgba(255,255,255,0.7)"}}>
              {syncStatus==="syncing"&&<span style={{display:"inline-block",width:8,height:8,border:"2px solid rgba(255,255,255,0.3)",borderTopColor:"white",borderRadius:"50%",animation:"spin .7s linear infinite",marginLeft:3}}/>}
              {syncStatus==="ok"&&`â˜ï¸ ${lastSync?lastSync.getHours()+":"+String(lastSync.getMinutes()).padStart(2,"0"):"Sheets"}`}
              {(syncStatus==="error"||syncStatus==="idle")&&`ğŸ’¾ ${L("syncLocal")}`}
            </span>
            <button title="×˜×¢×Ÿ ××—×“×© ×-Sheets" onClick={()=>{
              setSyncStatus("syncing");
              gsGetAll().then(data=>{
                if(data.error) throw new Error(data.error);
                if(data.participants?.length) setParticipants(data.participants);
                if(data.locations?.length)    setLocations(data.locations);
                if(data.settings&&Object.keys(data.settings).length) setSettings(s=>({...s,...data.settings}));
                setSyncStatus("ok");setLastSync(new Date());
                showToast("âœ… × ×˜×¢×Ÿ ×-Sheets");
              }).catch(e=>{setSyncStatus("error");showToast("×©×’×™××”: "+e.message,"error");});
            }} style={{background:"rgba(255,255,255,0.15)",border:"1px solid rgba(255,255,255,0.25)",color:"white",borderRadius:5,padding:"3px 8px",cursor:"pointer",fontSize:10,fontFamily:"inherit",fontWeight:700}}>
              {L("btnLoad")}
            </button>
            <button title="×©××•×¨ ×œ-Sheets" onClick={()=>{
              if(!window.confirm("×™×©×›×ª×‘ ××ª ×›×œ × ×ª×•× ×™ ×”-Sheets. ×œ×”××©×™×š?")) return;
              setSyncStatus("syncing");
              gsSaveAll({participants,locations,settings,user:settings.currentUser})
                .then(r=>{
                  if(r.error) throw new Error(r.error);
                  setSyncStatus("ok");setLastSync(new Date());
                  showToast("âœ… × ×©××¨ ×œ-Sheets");
                })
                .catch(e=>{setSyncStatus("error");showToast("×©×’×™××ª ×©××™×¨×”: "+e.message,"error");});
            }} style={{background:"rgba(255,255,255,0.9)",border:"none",color:"#4338CA",borderRadius:5,padding:"3px 9px",cursor:"pointer",fontSize:10,fontFamily:"inherit",fontWeight:800}}>
              {L("btnSave")}
            </button>
          </div>
        </div>
      </div>

      {/* Language warning */}
      {lang==="en"&&(
        <div style={{background:"#FFF7ED",borderBottom:"1px solid #FDE68A",padding:"4px 22px",fontSize:11,color:"#92400E",textAlign:"center"}}>
          âš ï¸ {L("langWarning")}
        </div>
      )}

      {/* â”€â”€ Global bar: stats + import/export + user â”€â”€ */}
      <div style={{background:T.surface,borderBottom:`1px solid ${T.border}`,padding:"6px 22px"}}>
        <div style={{maxWidth:1500,margin:"0 auto",display:"flex",gap:12,flexWrap:"wrap",alignItems:"center"}}>
          {/* Stats â€” completed moved to header, show others here */}
          {[{l:L("statReg"),v:stats.total,c:T.accent},{l:L("statAssigned"),v:stats.byStatus.assigned,c:"#059669"},{l:L("statConfirmed"),v:stats.byStatus.confirmed,c:"#D97706"},{l:L("statDeclined"),v:stats.byStatus.declined,c:"#DC2626"}].map(s=>(
            <div key={s.l} style={{textAlign:"center"}}>
              <div style={{fontSize:17,fontWeight:800,color:s.c,lineHeight:1}}>{s.v}</div>
              <div style={{fontSize:9,color:T.textFaint,marginTop:1}}>{s.l}</div>
            </div>
          ))}
          <div style={{width:1,height:24,background:T.border}}/>
          {/* Global actions */}
          <div style={{display:"flex",gap:7,flexWrap:"wrap",alignItems:"center",marginRight:"auto"}}>
            <span style={{fontSize:11,color:T.textMuted,background:T.tablehead,padding:"4px 10px",borderRadius:6,display:"flex",alignItems:"center",gap:5}}>
              ğŸ‘¤ {settings.currentUser}
            </span>
            <div style={{position:"relative"}}>
              <button onClick={e=>{e.stopPropagation();setExportMenu(v=>!v);}} style={{background:T.tablehead,color:T.text,border:`1px solid ${T.border}`,padding:"6px 11px",borderRadius:7,cursor:"pointer",fontSize:12,fontFamily:"inherit",fontWeight:600}}>
                {L("btnExport")}
              </button>
              {exportMenu&&(
                <div onClick={e=>e.stopPropagation()} style={{position:"absolute",top:"110%",right:0,background:T.surface,border:`1px solid ${T.border}`,borderRadius:9,boxShadow:"0 8px 24px rgba(0,0,0,0.15)",zIndex:200,minWidth:180}}>
                  <div style={{padding:"6px 12px",fontSize:10,color:T.textFaint,borderBottom:`1px solid ${T.border}`}}>
                    {selected.size>0?`${selected.size} × ×‘×—×¨×•`:"×›×œ ×”× ×‘×“×§×™×"}
                  </div>
                  {[{l:"ğŸ“‹ ×›×œ ×”× ×ª×•× ×™×",f:"all"},{l:"ğŸ“§ ××™×™×œ×™× ×‘×œ×‘×“",f:"email"},{l:"ğŸ“± ×˜×œ×¤×•× ×™× ×‘×œ×‘×“",f:"phone"}].map(i=>(
                    <button key={i.f} onClick={()=>doExport(i.f)} style={{display:"block",width:"100%",textAlign:"right",padding:"9px 14px",border:"none",background:"none",cursor:"pointer",fontSize:12,fontFamily:"inherit",color:T.text,borderBottom:`1px solid ${T.border}`}}>{i.l}</button>
                  ))}
                  <button onClick={()=>{doExportJSON();setExportMenu(false);}} style={{display:"block",width:"100%",textAlign:"right",padding:"9px 14px",border:"none",background:"none",cursor:"pointer",fontSize:12,fontFamily:"inherit",color:T.text}}>ğŸ—‚ JSON ×’×™×‘×•×™</button>
                </div>
              )}
            </div>
            {/* Import buttons + status indicator */}
            <div style={{display:"flex",gap:6,alignItems:"center",flexWrap:"wrap"}}>
              <button onClick={()=>fileRef.current?.click()}
                disabled={importStatus?.state==="loading"}
                style={{background:T.accent,color:"white",border:"none",padding:"6px 11px",borderRadius:7,cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit",opacity:importStatus?.state==="loading"?0.6:1}}>
                {L("btnImportCSV")}
              </button>
              <input ref={fileRef} type="file" accept=".csv" style={{display:"none"}} onChange={e=>{handleFile(e.target.files[0]);e.target.value="";}}/>
              <button onClick={()=>{
                setImportStatus({state:"loading", msg:"××™×™×‘× ×-Google Sheets..."});
                fetch(`${GS_URL}?action=importFromForm`)
                  .then(r=>r.json())
                  .then(d=>{
                    if(d.error) throw new Error(d.error);
                    return fetch(`${GS_URL}?action=getAll`).then(r=>r.json()).then(data=>{
                      if(data.participants?.length) setParticipants(data.participants);
                      setSyncStatus("ok"); setLastSync(new Date());
                      setImportStatus({state:"ok", msg:`âœ… × ×•×¡×¤×• ${d.added}, ×¢×•×“×›× ×• ${d.updated}`});
                      setTimeout(()=>setImportStatus(null),4000);
                    });
                  })
                  .catch(e=>{
                    const msg = e.message.includes("Unknown action") 
                      ? "×¢×“×›×Ÿ ××ª Apps Script ×œ-v3 ×•×¤×¨×¡× ×’×¨×¡×” ×—×“×©×”"
                      : e.message;
                    setImportStatus({state:"error", msg:`×©×’×™××”: ${msg}`});
                    setTimeout(()=>setImportStatus(null),7000);
                  });
              }}
                disabled={importStatus?.state==="loading"}
                style={{background:"#059669",color:"white",border:"none",padding:"6px 11px",borderRadius:7,cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit",opacity:importStatus?.state==="loading"?0.6:1}}>
                {L("btnImportSheets")}
              </button>

              {/* Import status indicator */}
              {importStatus&&(
                <div style={{
                  display:"flex",alignItems:"center",gap:7,
                  padding:"5px 12px",borderRadius:20,fontSize:12,fontWeight:600,
                  background:importStatus.state==="loading"?"#EEF2FF":importStatus.state==="ok"?"#ECFDF5":"#FEF2F2",
                  color:importStatus.state==="loading"?"#4338CA":importStatus.state==="ok"?"#059669":"#DC2626",
                  border:`1px solid ${importStatus.state==="loading"?"#C7D4FF":importStatus.state==="ok"?"#A7F3D0":"#FECACA"}`,
                  transition:"all .3s",
                }}>
                  {importStatus.state==="loading"&&(
                    <span style={{
                      display:"inline-block",width:13,height:13,border:"2px solid #C7D4FF",
                      borderTopColor:"#4338CA",borderRadius:"50%",
                      animation:"spin .7s linear infinite",flexShrink:0
                    }}/>
                  )}
                  {importStatus.state==="ok"&&<span>âœ…</span>}
                  {importStatus.state==="error"&&<span>âš ï¸</span>}
                  <span>{importStatus.msg}</span>
                </div>
              )}
            </div>          </div>
        </div>
      </div>

      {/* â”€â”€ Tabs â”€â”€ */}
      <div style={{background:T.surface,borderBottom:`1px solid ${T.border}`,padding:"0 22px"}}>
        <div style={{maxWidth:1500,margin:"0 auto",display:"flex"}}>
          {[{id:"assignments",l:L("tabAssign")},{id:"calendar",l:L("tabCalendar")},{id:"charts",l:L("tabCharts")},{id:"emails",l:L("tabEmails")},{id:"locations",l:L("tabLocations")}].map(t=>(
            <button key={t.id} onClick={()=>setTab(t.id)} style={{padding:"10px 14px",border:"none",background:"none",cursor:"pointer",fontSize:13,fontWeight:tab===t.id?700:400,color:tab===t.id?T.accent:T.textMuted,borderBottom:tab===t.id?`2px solid ${T.accent}`:"2px solid transparent",fontFamily:"inherit",transition:"color .2s"}}>
              {t.l}
            </button>
          ))}
        </div>
      </div>

      <div style={{flex:1,overflowY:"auto"}}>
      <div style={{maxWidth:1500,margin:"0 auto",padding:"16px 22px"}}>

        {/* â•â• ASSIGNMENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab==="assignments"&&(
          <div>
            {/* â”€â”€ Table toolbar: primary actions + bulk ops â”€â”€ */}
            <div style={{marginBottom:8}}>
              {/* Row 1: always-visible actions */}
              <div style={{display:"flex",gap:7,marginBottom:6,flexWrap:"wrap",alignItems:"center"}}>
                {/* Undo / Redo */}
                <button onClick={undo} disabled={!history.length} title={lang==="en"?"Undo":"×‘×˜×œ"} style={{background:T.tablehead,color:history.length?T.text:T.textFaint,border:`1px solid ${T.border}`,padding:"6px 10px",borderRadius:7,cursor:history.length?"pointer":"default",fontSize:13,fontFamily:"inherit",opacity:history.length?1:0.4}} title={undoLabel?`${lang==="en"?"Undo":"×‘×˜×œ"}: ${undoLabel}`:(lang==="en"?"Nothing to undo":"××™×Ÿ ××” ×œ×‘×˜×œ")}>
                  â†©{undoLabel?<span style={{fontSize:9,marginRight:3,color:T.textMuted,maxWidth:60,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"inline-block",verticalAlign:"middle"}}>{undoLabel}</span>:null}
                </button>
                <button onClick={redo} disabled={!future.length} title={lang==="en"?"Redo":"×‘×¦×¢ ×©×•×‘"} style={{background:T.tablehead,color:future.length?T.text:T.textFaint,border:`1px solid ${T.border}`,padding:"6px 10px",borderRadius:7,cursor:future.length?"pointer":"default",fontSize:13,fontFamily:"inherit",opacity:future.length?1:0.4}}>
                  â†ª
                </button>
                <div style={{width:1,height:22,background:T.border,margin:"0 2px"}}/>
                <button onClick={()=>{setEditP(emptyP());setModal("addEdit");}} style={{background:"#059669",color:"white",border:"none",padding:"7px 13px",borderRadius:7,cursor:"pointer",fontWeight:700,fontSize:12,fontFamily:"inherit",display:"flex",alignItems:"center",gap:5}}>
                  {L("btnAddParticipant")}
                </button>
                <button onClick={()=>autoAssign(null)} style={{background:"linear-gradient(135deg,#4338CA,#7C3AED)",color:"white",border:"none",padding:"7px 13px",borderRadius:7,cursor:"pointer",fontWeight:700,fontSize:12,fontFamily:"inherit"}}>
                  {L("btnAutoAssign")}
                </button>
                {/* Counter pill */}
                <span style={{fontSize:12,color:T.textMuted,background:T.surface,border:`1px solid ${T.border}`,padding:"5px 11px",borderRadius:20,marginRight:"auto"}}>
                  {selected.size>0
                    ? <><strong style={{color:T.accent}}>{selected.size}</strong> ××¡×•×× ×™× ××ª×•×š {sortedFiltered.length} / {participants.length}</>
                    : <>{sortedFiltered.length} / {participants.length} × ×‘×“×§×™×</>
                  }
                </span>
              </div>

              {/* Row 2: bulk operations â€” shown only when rows are selected */}
              {selected.size>0&&(
                <div style={{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center",background:T.rowSel,border:`1px solid ${T.accent}44`,borderRadius:9,padding:"8px 12px"}}>
                  <span style={{fontSize:11,fontWeight:700,color:T.accent,minWidth:80}}>ğŸ“Œ {selected.size} × ×‘×—×¨×•:</span>

                  {/* Auto-assign selected */}
                  {selCanAutoAssign&&(
                    <button onClick={()=>{autoAssign(selected);}} style={{background:"linear-gradient(135deg,#4338CA,#7C3AED)",color:"white",border:"none",padding:"5px 11px",borderRadius:6,cursor:"pointer",fontWeight:700,fontSize:11,fontFamily:"inherit"}}>
                      âš¡ ×©×‘×¥ × ×‘×—×¨×™×
                    </button>
                  )}

                  {/* Clear assignments of selected */}
                  {selHasAssigned&&(
                    <button onClick={()=>{
                      const ids=selected;
                      const count=[...ids].filter(id=>participants.find(p=>p.id===id)?.assigned).length;
                      if(!window.confirm(`×œ× ×§×•×ª ×©×™×‘×•×¥ ×©×œ ${count} × ×‘×“×§×™×?`)) return;
                      setParticipants(prev=>prev.map(p=>ids.has(p.id)&&p.assigned?{...p,assigned:null,status:"pending"}:p));
                      addLog("× ×™×§×•×™ ×©×™×‘×•×¦×™×",`× ×•×§×• ${count} ×©×™×‘×•×¦×™× ×¢"×™ ${settings.currentUser}`);
                      showToast(`ğŸ—‘ × ×•×§×• ${count} ×©×™×‘×•×¦×™×`);
                      setSelected(new Set());
                    }} style={{background:"#FEF2F2",color:"#DC2626",border:"1px solid #FECACA",padding:"5px 11px",borderRadius:6,cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:600}}>
                      {L("btnClearAssign")}
                    </button>
                  )}

                  {/* Bulk set status */}
                  <select defaultValue="" onChange={e=>{
                    if(!e.target.value) return;
                    const status=e.target.value;
                    setParticipants(prev=>prev.map(p=>selected.has(p.id)?{...p,status}:p));
                    addLog("×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡",`×¡×˜×˜×•×¡ "${statusMeta[status].label}" ×œ-${selected.size} × ×‘×“×§×™×`);
                    showToast(`âœ… ×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ-${selected.size} × ×‘×“×§×™×`);
                    e.target.value="";
                  }} style={{padding:"5px 8px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:11,fontFamily:"inherit",background:T.inputBg,color:T.text,cursor:"pointer"}}>
                    <option value="">×¡×˜×˜×•×¡ ×œ× ×‘×—×¨×™×â€¦</option>
                    {Object.entries(statusMeta).map(([v,m])=><option key={v} value={v}>{m.label}</option>)}
                  </select>

                  {/* Bulk set location */}
                  <select defaultValue="" onChange={e=>{
                    if(!e.target.value) return;
                    const locId=parseInt(e.target.value);
                    const room=locById[locId]?.rooms[0]||"";
                    setParticipants(prev=>prev.map(p=>selected.has(p.id)&&p.assigned?{...p,assigned:{...p.assigned,locationId:locId,room}}:p));
                    addLog("×¢×“×›×•×Ÿ ××™×§×•×",`××™×§×•× "${locById[locId]?.name}" ×œ-${selected.size} × ×‘×“×§×™×`);
                    showToast(`ğŸ“ ××™×§×•× ×¢×•×“×›×Ÿ`);
                    e.target.value="";
                  }} style={{padding:"5px 8px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:11,fontFamily:"inherit",background:T.inputBg,color:T.text,cursor:"pointer"}}>
                    <option value="">××™×§×•× ×œ× ×‘×—×¨×™×â€¦</option>
                    {locations.map(l=><option key={l.id} value={l.id}>{l.name}</option>)}
                  </select>

                  {/* Bulk set room */}
                  {locations.some(l=>l.rooms.length>0)&&(
                    <select defaultValue="" onChange={e=>{
                      if(!e.target.value) return;
                      const room=e.target.value;
                      setParticipants(prev=>prev.map(p=>selected.has(p.id)&&p.assigned?{...p,assigned:{...p.assigned,room}}:p));
                      showToast(`ğŸ« ×›×™×ª×” ×¢×•×“×›× ×”`);
                      e.target.value="";
                    }} style={{padding:"5px 8px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:11,fontFamily:"inherit",background:T.inputBg,color:T.text,cursor:"pointer"}}>
                      <option value="">×›×™×ª×”/×—×“×¨ ×œ× ×‘×—×¨×™×â€¦</option>
                      {[...new Set(locations.flatMap(l=>l.rooms))].map(r=><option key={r} value={r}>{r}</option>)}
                    </select>
                  )}

                  {/* Bulk set location preference */}
                  <div style={{position:"relative",display:"inline-flex",alignItems:"center",gap:3}}>
                    <span style={{fontSize:10,color:T.textMuted,fontWeight:600,whiteSpace:"nowrap"}}>ğŸ“ ×”×¢×“×¤×”:</span>
                    {locations.map(loc=>{
                      const allOn=selList.every(p=>(p.locPref||[]).includes(loc.id));
                      const someOn=selList.some(p=>(p.locPref||[]).includes(loc.id));
                      const c=LOC_COLORS[(locations.findIndex(l=>l.id===loc.id))%LOC_COLORS.length];
                      return(
                        <button key={loc.id} onClick={()=>{
                          // If all selected have it â†’ remove from all; otherwise add to all
                          setParticipants(prev=>prev.map(p=>{
                            if(!selected.has(p.id)) return p;
                            const cur=p.locPref||[];
                            const next=allOn?cur.filter(x=>x!==loc.id):cur.includes(loc.id)?cur:[...cur,loc.id];
                            return {...p,locPref:next};
                          }));
                          addLog("×¢×“×›×•×Ÿ ×”×¢×“×¤×ª ××™×§×•×",`"${loc.name}" ${allOn?"×”×•×¡×¨ ×":"× ×•×¡×£ ×œ"}-${selected.size} × ×‘×“×§×™×`);
                          showToast(`ğŸ“ ${loc.name} ${allOn?"×”×•×¡×¨":"× ×•×¡×£"} ×œ-${selected.size} × ×‘×“×§×™×`);
                        }} style={{
                          background:allOn?c.bg:someOn?c.bg+"88":T.tablehead,
                          color:allOn?c.text:someOn?c.text:T.textFaint,
                          border:`1.5px solid ${allOn?c.border:someOn?c.border+"88":T.border}`,
                          borderRadius:5,padding:"3px 9px",fontSize:11,cursor:"pointer",
                          fontFamily:"inherit",fontWeight:allOn?700:400,
                          transition:"all .15s",
                        }}>
                          {allOn?"âœ“ ":someOn?"~ ":""}{loc.name}
                        </button>
                      );
                    })}
                  </div>

                    {selList.some(p=>p.email)&&(
                      <div style={{position:"relative"}}>
                        <button onClick={e=>{e.stopPropagation();setBulkEmailOpen(v=>!v);setExportMenu(false);}} style={{background:"#EEF2FF",color:"#4338CA",border:"1px solid #C7D4FF",padding:"5px 11px",borderRadius:6,cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:600}}>
                          âœ‰ï¸ {lang==="en"?"Email selected":"××™×™×œ ×œ× ×‘×—×¨×™×"} ({selList.filter(p=>p.email).length}) â–¾
                        </button>
                        {bulkEmailOpen&&(
                          <div onClick={e=>e.stopPropagation()} style={{position:"absolute",top:"110%",right:0,background:T.surface,border:`1px solid ${T.border}`,borderRadius:9,boxShadow:"0 8px 24px rgba(0,0,0,0.15)",zIndex:300,minWidth:200,overflow:"hidden"}}>
                            {[
                              {type:"invitation",icon:"ğŸ“¨",he:"×”×–×× ×” ×œ× ×™×¡×•×™",en:"Invitation",cond:p=>p.email&&p.assigned},
                              {type:"reminder",icon:"ğŸ””",he:"×ª×–×›×•×¨×ª",en:"Reminder",cond:p=>p.email&&p.assigned},
                              {type:"noAvailability",icon:"âš ï¸",he:"×‘×§×©×ª ×–××™× ×•×ª",en:"Availability request",cond:p=>p.email},
                              {type:"thanks",icon:"ğŸ™",he:"×ª×•×“×” (×”×©×œ×™×)",en:"Thank you",cond:p=>p.email&&p.status==="completed"},
                            ].map(opt=>{
                              const targets=selList.filter(opt.cond);
                              if(targets.length===0) return null;
                              return(
                                <button key={opt.type} onClick={()=>{
                                  targets.forEach(p=>{
                                    let subj,body;
                                    if(opt.type==="thanks"){
                                      subj=`×ª×•×“×” ×¢×œ ×”×©×ª×ª×¤×•×ª×š â€“ ${settings.experimentName}`;
                                      body=`×©×œ×•× ${p.name},\n\n×ª×•×“×” ×¨×‘×” ×¢×œ ×”×©×ª×ª×¤×•×ª×š ×‘× ×™×¡×•×™!\n\n×‘×‘×¨×›×”,\n${settings.currentUser}`;
                                    } else {
                                      const e=buildEmail(p,opt.type);
                                      subj=e.subject; body=e.body;
                                    }
                                    sendViaGmail(subj,body,p.email);
                                  });
                                  setBulkEmailOpen(false);
                                  showToast(`âœ‰ï¸ ${targets.length} ${lang==="en"?"emails opened":"×—×œ×•× ×•×ª × ×¤×ª×—×•"}`);
                                }} style={{display:"flex",alignItems:"center",gap:8,width:"100%",textAlign:"right",padding:"10px 14px",border:"none",background:"none",cursor:"pointer",fontSize:12,fontFamily:"inherit",color:T.text,borderBottom:`1px solid ${T.border}`}}>
                                  <span>{opt.icon}</span>
                                  <span style={{flex:1}}>{lang==="en"?opt.en:opt.he}</span>
                                  <span style={{fontSize:10,color:T.textMuted,background:T.tablehead,borderRadius:10,padding:"1px 7px"}}>{targets.length}</span>
                                </button>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    )}

                  <button onClick={()=>setSelected(new Set())} style={{background:"none",border:"none",cursor:"pointer",color:T.textFaint,fontSize:18,padding:"0 4px",marginRight:"auto"}}>Ã—</button>
                </div>
              )}
            </div>

            {/* â”€â”€ Filters row â”€â”€ */}
            <div style={{display:"flex",gap:7,marginBottom:8,flexWrap:"wrap",alignItems:"center",background:T.surface,padding:"8px 12px",borderRadius:10,border:`1px solid ${T.border}`}}>
              <input placeholder={L("searchPlaceholder")} value={filters.name} onChange={e=>setFilters(f=>({...f,name:e.target.value}))}
                style={{padding:"5px 9px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:12,fontFamily:"inherit",background:T.inputBg,color:T.text,minWidth:140}}/>
              <select value={filters.assigned} onChange={e=>setFilters(f=>({...f,assigned:e.target.value}))} style={{padding:"5px 7px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:12,fontFamily:"inherit",background:T.inputBg,color:T.text}}>
                <option value="">{L("filterAssigned")}</option><option value="yes">{L("filterYes")}</option><option value="no">{L("filterNo")}</option>
              </select>
              {(filters.name||filters.assigned||filters.status.length>0||filters.gender.length>0||filters.location.length>0||filters.day.length>0||filters.slot.length>0||filters.locPref.length>0||filters.age.length>0)&&(
                <button onClick={()=>setFilters({name:"",status:[],location:[],day:[],gender:[],assigned:"",slot:[],locPref:[],age:[]})} style={{background:"#FEF2F2",color:"#DC2626",border:"none",padding:"5px 10px",borderRadius:6,cursor:"pointer",fontSize:11,fontFamily:"inherit"}}>{L("clearAll")}</button>
              )}
            </div>

            <div style={{overflowX:"auto",borderRadius:10,border:`1px solid ${T.border}`,background:T.surface}}>
              <table style={{width:"100%",borderCollapse:"collapse",minWidth:1100}}>
                <thead>
                  <tr style={{background:T.tablehead,borderBottom:`2px solid ${T.border}`}}>
                    <th style={{padding:"8px 10px",width:32}}>
                      <input type="checkbox" checked={sortedFiltered.length>0&&sortedFiltered.every(p=>selected.has(p.id))} onChange={()=>{
                        const ids=sortedFiltered.map(p=>p.id);
                        const allOn=ids.every(id=>selected.has(id));
                        setSelected(prev=>{const n=new Set(prev);ids.forEach(id=>allOn?n.delete(id):n.add(id));return n;});
                      }} style={{cursor:"pointer"}}/>
                    </th>
                    {[{k:"name",l:L("colName")},{k:"email",l:L("colEmail")}].map(h=>(
                      <th key={h.k} onClick={()=>toggleSort(h.k)} style={{padding:"8px 10px",textAlign:"start",fontSize:11,color:T.textMuted,fontWeight:700,cursor:"pointer",whiteSpace:"nowrap",userSelect:"none"}}>
                        <SortIcon col={h.k}/>{h.l}
                      </th>
                    ))}
                    {(()=>{
                      // Excel-style column header: sort + filter dropdown
                      const ExcelTh = ({col, label, options, fkey, valFn}) => {
                        const active = (filters[fkey]||[]).length > 0 || sortCol===col;
                        const isOpen = colMenu?.col===col;
                        const selected_vals = filters[fkey]||[];
                        return (
                          <th style={{padding:"4px 6px",textAlign:"start",fontSize:11,color:active?T.accent:T.textMuted,fontWeight:700,whiteSpace:"nowrap",position:"relative",userSelect:"none"}}>
                            <div style={{display:"flex",alignItems:"center",gap:2}}>
                              <span onClick={()=>toggleSort(col)} style={{cursor:"pointer",flex:1}}>
                                <SortIcon col={col}/>{label}
                              </span>
                              <button onClick={e=>{
                                e.stopPropagation();
                                const r=e.currentTarget.getBoundingClientRect();
                                setColMenu(isOpen?null:{col,fkey,options,x:r.left,y:r.bottom+4});
                              }} style={{
                                background:selected_vals.length>0?"#4338CA":T.surface,
                                color:selected_vals.length>0?"white":T.textMuted,
                                border:`1px solid ${selected_vals.length>0?"#4338CA":T.border}`,
                                borderRadius:3,padding:"1px 4px",cursor:"pointer",fontSize:9,fontFamily:"inherit",fontWeight:700,lineHeight:1
                              }}>â–¼{selected_vals.length>0?` ${selected_vals.length}`:""}</button>
                            </div>
                          </th>
                        );
                      };
                      const slotOpts=[{v:"×‘×•×§×¨ (08:00-12:00)",l:L("slotMorning")},{v:"×¦×”×¨×™×™× (12:00-18:00)",l:L("slotAfternoon")}];
                      const dayOpts=DAYS.map(d=>({v:d,l:`×™×•× ${dayNames[d]}`}));
                      const locOpts=locations.map(l=>({v:String(l.id),l:l.name}));
                      const statusOpts=Object.entries(statusMeta).map(([v,m])=>({v,l:m.label}));
                      const genderOpts=[{v:"×’×‘×¨",l:L("genderM")},{v:"××™×©×”",l:L("genderF")},{v:"××—×¨",l:L("genderO")}];
                      const locPrefOpts=locations.map(l=>({v:String(l.id),l:l.name}));
                      const ageOpts=[...new Set(participants.map(p=>String(p.age||"")).filter(Boolean))].sort((a,b)=>parseInt(a)-parseInt(b)).map(v=>({v,l:v}));
                      const availOpts=[...new Set(participants.flatMap(p=>Object.entries(p.availability||{}).filter(([,s])=>s.length>0).map(([d,])=>`×™×•× ${dayNames[d]||d}`)))].sort().map(v=>({v:v.replace("×™×•× ",""),l:v}));
                      return (<>
                        <ExcelTh col="age"     label="×’×™×œ"         fkey="age"     options={ageOpts}/>
                        <ExcelTh col="gender"  label="××’×“×¨"        fkey="gender"  options={genderOpts}/>
                        <th style={{padding:"8px 6px",fontSize:11,color:T.textMuted,fontWeight:700,whiteSpace:"nowrap"}}>{L("colAvail")}</th>
                        <ExcelTh col="assigned_day"  label="×™×•×"   fkey="day"     options={dayOpts}/>
                        <ExcelTh col="assigned_slot" label="××©××¨×ª" fkey="slot"    options={slotOpts}/>
                        <ExcelTh col="assigned_loc"  label="××™×§×•×" fkey="location" options={locOpts}/>
                        <th style={{padding:"8px 6px",fontSize:11,color:T.textMuted,fontWeight:700,whiteSpace:"nowrap"}}>{L("colRoom")}</th>
                        <ExcelTh col="status"  label="×¡×˜×˜×•×¡"       fkey="status"  options={statusOpts}/>
                        <ExcelTh col="locPref" label="×”×¢×“×¤×ª ××™×§×•×" fkey="locPref" options={locPrefOpts}/>
                        <th style={{padding:"8px 6px",fontSize:11,color:T.textMuted,fontWeight:700,whiteSpace:"nowrap"}}>{L("colNotes")}</th>
                        <th style={{padding:"8px 6px",fontSize:11,color:T.textMuted,fontWeight:700,whiteSpace:"nowrap"}}>{L("colActions")}</th>
                      </>);
                    })()}
                  </tr>
                </thead>
                <tbody>
                  {sortedFiltered.map((p,i)=>{
                    const sm=statusMeta[p.status];
                    const lc=p.assigned?locColor(p.assigned.locationId):null;
                    const isSel=selected.has(p.id);
                    return (
                      <tr key={p.id} style={{borderBottom:`1px solid ${T.border}`,background:isSel?T.rowSel:i%2===0?T.rowEven:T.rowOdd,transition:"background .1s"}}>
                        <td style={{padding:"6px 10px",textAlign:"center"}}>
                          <input type="checkbox" checked={isSel} onChange={()=>toggleSel(p.id)} style={{cursor:"pointer"}}/>
                        </td>
                        {/* Name */}
                        <td style={{padding:"6px 10px",fontWeight:700,fontSize:13,whiteSpace:"nowrap",color:T.text}}>{p.name}</td>
                        {/* Email */}
                        <td style={{padding:"6px 10px",fontSize:11,color:T.textMuted,maxWidth:140,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                          {p.email||<span style={{color:"#FCA5A5"}}>×—×¡×¨</span>}
                        </td>
                        {/* Age */}
                        <td style={{padding:"6px 10px",fontSize:12,color:T.textMuted,textAlign:"center"}}>{p.age||"â€”"}</td>
                        {/* Gender */}
                        <td style={{padding:"6px 10px",fontSize:11}}>
                          {p.gender&&<span style={{background:p.gender==="×’×‘×¨"?"#EEF2FF":"#FDF4FF",color:p.gender==="×’×‘×¨"?"#4338CA":"#7E22CE",borderRadius:4,padding:"1px 6px",fontSize:10,fontWeight:700}}>{p.gender}</span>}
                        </td>
                        {/* Availability */}
                        <td style={{padding:"4px 6px",minWidth:140}}>
                          <div style={{display:"flex",gap:3,flexWrap:"wrap",minWidth:130}}>
                            {DAYS.filter(d=>p.availability[d]?.length>0).map(d=>(
                              <span key={d} style={{background:T.tablehead,color:T.accent,borderRadius:4,padding:"2px 5px",fontSize:9,fontWeight:700,border:`1px solid ${T.border}`,whiteSpace:"nowrap"}}>
                                {lang==="en"?["SUN","MON","TUE","WED","THU","FRI"]["××‘×’×“×”×•".indexOf(d)]||d:d}
                              </span>
                            ))}
                            {Object.values(p.availability).every(s=>s.length===0)&&<span style={{color:"#FCA5A5",fontSize:10}}>â€”</span>}
                          </div>
                        </td>
                        {/* Day */}
                        <td style={{padding:"4px 5px"}}>
                          <select value={p.assigned?.day||""} onChange={e=>{
                            const day=e.target.value;
                            if(!day){clearA(p.id);return;}
                            const slot=p.availability[day]?.[0]||SLOTS[0];
                            assignP(p.id,day,slot,locations[0]?.id||null,locations[0]?.rooms[0]||"");
                          }} style={{padding:"3px 4px",border:`1px solid ${T.border}`,borderRadius:5,fontSize:11,fontFamily:"inherit",background:p.assigned?T.rowSel:T.inputBg,color:p.assigned?T.accent:T.text,cursor:"pointer",minWidth:75}}>
                            <option value="">â€” ×™×•× â€”</option>
                            {DAYS.map(d=><option key={d} value={d}>{p.availability[d]?.length>0?"âœ“ ":"  "}×™×•× {dayNames[d]}</option>)}
                          </select>
                        </td>
                        {/* Slot */}
                        <td style={{padding:"4px 5px"}}>
                          <select value={p.assigned?.slot||""} disabled={!p.assigned} onChange={e=>updP(p.id,{assigned:{...p.assigned,slot:e.target.value}})}
                            style={{padding:"3px 4px",border:`1px solid ${T.border}`,borderRadius:5,fontSize:11,fontFamily:"inherit",background:p.assigned?T.rowSel:T.tablehead,color:p.assigned?T.accent:T.textFaint,cursor:p.assigned?"pointer":"default",minWidth:85,opacity:p.assigned?1:0.5}}>
                            {SLOTS.map(s=><option key={s} value={s}>{s.includes("×‘×•×§×¨")?L("slotMorning"):L("slotAfternoon")}</option>)}
                          </select>
                        </td>
                        {/* Location */}
                        <td style={{padding:"4px 5px"}}>
                          <select value={p.assigned?.locationId||""} disabled={!p.assigned} onChange={e=>{
                            const locId=parseInt(e.target.value)||null;
                            updP(p.id,{assigned:{...p.assigned,locationId:locId,room:locById[locId]?.rooms[0]||""}});
                          }} style={{padding:"3px 4px",border:`1px solid ${lc?.border||T.border}`,borderRadius:5,fontSize:11,fontFamily:"inherit",background:lc?.bg||T.tablehead,color:lc?.text||T.textFaint,cursor:p.assigned?"pointer":"default",minWidth:60,opacity:p.assigned?1:0.5}}>
                            <option value="">â€” ××™×§×•× â€”</option>
                            {locations.map(l=><option key={l.id} value={l.id}>{l.name}</option>)}
                          </select>
                        </td>
                        {/* Room */}
                        <td style={{padding:"4px 5px"}}>
                          {p.assigned&&p.assigned.locationId?(()=>{
                            const rms=locById[p.assigned.locationId]?.rooms||[];
                            return rms.length>0
                              ?<select value={p.assigned.room||""} onChange={e=>updP(p.id,{assigned:{...p.assigned,room:e.target.value}})} style={{padding:"3px 4px",border:`1px solid ${T.border}`,borderRadius:5,fontSize:11,fontFamily:"inherit",background:T.inputBg,color:T.text,minWidth:70}}>
                                <option value="">â€” ×—×“×¨ â€”</option>
                                {rms.map(r=><option key={r} value={r}>{r}</option>)}
                              </select>
                              :<input value={p.assigned.room||""} onChange={e=>updP(p.id,{assigned:{...p.assigned,room:e.target.value}})} placeholder="×™×“× ×™" style={{padding:"3px 5px",border:`1px solid ${T.border}`,borderRadius:5,fontSize:11,fontFamily:"inherit",width:65,background:T.inputBg,color:T.text}}/>;
                          })():<span style={{color:T.textFaint,fontSize:10}}>â€”</span>}
                        </td>
                        {/* Status */}
                        <td style={{padding:"4px 5px"}}>
                          <select value={p.status} onChange={e=>updP(p.id,{status:e.target.value},`×¡×˜×˜×•×¡ ${p.name}: ${statusMeta[e.target.value].label}`)}
                            style={{padding:"3px 5px",borderRadius:5,border:`1px solid ${sm.border}`,background:sm.bg,color:sm.text,fontSize:11,fontWeight:700,cursor:"pointer",fontFamily:"inherit"}}>
                            {Object.entries(statusMeta).map(([v,m])=><option key={v} value={v}>{m.label}</option>)}
                          </select>
                        </td>
                        {/* Location preference */}
                        <td style={{padding:"4px 5px",minWidth:110}}>
                          <div style={{display:"flex",flexWrap:"wrap",gap:3}}>
                            {locations.map(loc=>{
                              const pref=p.locPref||[];
                              const on=pref.includes(loc.id);
                              const c=LOC_COLORS[(locations.findIndex(l=>l.id===loc.id))%LOC_COLORS.length];
                              return(
                                <button key={loc.id} onClick={()=>{
                                  const cur=p.locPref||[];
                                  const next=on?cur.filter(x=>x!==loc.id):[...cur,loc.id];
                                  updP(p.id,{locPref:next},`×”×¢×“×¤×ª ××™×§×•× ${p.name}`);
                                }} style={{
                                  background:on?c.bg:T.tablehead,
                                  color:on?c.text:T.textFaint,
                                  border:`1px solid ${on?c.border:T.border}`,
                                  borderRadius:4,padding:"2px 6px",fontSize:10,
                                  cursor:"pointer",fontFamily:"inherit",fontWeight:on?700:400,
                                  transition:"all .15s"
                                }}>
                                  {on?"âœ“ ":""}{loc.name}
                                </button>
                              );
                            })}
                          </div>
                        </td>
                        {/* Notes */}
                        <td style={{padding:"4px 5px"}}>
                          <input value={p.notes||""} onChange={e=>updP(p.id,{notes:e.target.value})} placeholder="×”×¢×¨×•×ªâ€¦"
                            style={{padding:"3px 7px",border:`1px solid ${p.notes?"#FDE68A":T.border}`,borderRadius:5,fontSize:11,fontFamily:"inherit",width:100,background:p.notes?"#FFFBEB":T.inputBg,color:T.text}}/>
                        </td>
                        {/* Actions */}
                        <td style={{padding:"4px 5px"}}>
                          <div style={{display:"flex",gap:3}}>
                            <button title="×¢×¨×•×š" onClick={()=>{setEditP({...p});setModal("addEdit");}} style={{background:T.tablehead,color:T.accent,border:`1px solid ${T.border}`,padding:"3px 6px",borderRadius:4,fontSize:11,cursor:"pointer"}}>âœï¸</button>
                            {p.email&&(
                              <button title={lang==="en"?"Send email":"×©×œ×— ××™×™×œ"} onClick={e=>{
                                const r=e.currentTarget.getBoundingClientRect();
                                setRowEmailMenu(rowEmailMenu?.pid===p.id?null:{pid:p.id,x:r.left,y:r.bottom+4,p});
                              }} style={{background:"#EEF2FF",color:"#4338CA",border:"1px solid #C7D4FF",padding:"3px 6px",borderRadius:4,fontSize:11,cursor:"pointer",fontWeight:700}}>
                                âœ‰ï¸â–¾
                              </button>
                            )}
                            {p.assigned&&<button title="× ×§×” ×©×™×‘×•×¥" onClick={()=>clearA(p.id)} style={{background:"#FEF2F2",color:"#9CA3AF",border:"none",padding:"3px 6px",borderRadius:4,fontSize:11,cursor:"pointer"}}>âœ•</button>}
                            <button title="××—×§" onClick={()=>{if(window.confirm(`×œ××—×•×§ ${p.name}?`)){setParticipantsUndo(prev=>prev.filter(x=>x.id!==p.id), `${lang==="en"?"Delete":"××—×§"}: ${p.name}`);addLog("××—×™×§×”",`× ××—×§: ${p.name}`);}}} style={{background:T.tablehead,color:T.textFaint,border:`1px solid ${T.border}`,padding:"3px 6px",borderRadius:4,fontSize:11,cursor:"pointer"}}>ğŸ—‘</button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              {sortedFiltered.length===0&&<div style={{padding:"30px",textAlign:"center",color:T.textFaint,fontSize:13}}>××™×Ÿ ×ª×•×¦××•×ª ×œ×¡×™× ×•×Ÿ ×”× ×•×›×—×™</div>}
            </div>
          </div>
        )}

        {/* â•â• CALENDAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab==="calendar"&&(
          <div>
            <div style={{display:"flex",gap:8,marginBottom:14,alignItems:"center",flexWrap:"wrap"}}>
              <div style={{display:"flex",background:T.tablehead,borderRadius:8,overflow:"hidden",border:`1px solid ${T.border}`}}>
                {["week","month"].map(m=>(
                  <button key={m} onClick={()=>setCalMode(m)} style={{padding:"7px 14px",border:"none",background:calMode===m?T.accent:"transparent",color:calMode===m?"white":T.textMuted,cursor:"pointer",fontSize:12,fontWeight:calMode===m?700:400,fontFamily:"inherit",transition:"all .2s"}}>
                    {m==="week"?"ğŸ“… ×©×‘×•×¢×™":"ğŸ“† ×—×•×“×©×™"}
                  </button>
                ))}
              </div>
              {calMode==="week"&&(
                <div style={{display:"flex",alignItems:"center",gap:7}}>
                  <button onClick={()=>setWeekOffset(w=>w-1)} style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:6,padding:"5px 10px",cursor:"pointer",fontSize:14,color:T.text}}>â€¹</button>
                  <span style={{fontSize:12,fontWeight:600,color:T.text,minWidth:190,textAlign:"center"}}>
                    {weekDates[0]&&`${fmtDate(weekDates[0])} â€“ ${fmtDate(weekDates[5])}`}
                    {weekOffset===0&&<span style={{color:T.accent,fontSize:10,marginRight:5}}>(×©×‘×•×¢ × ×•×›×—×™)</span>}
                  </span>
                  <button onClick={()=>setWeekOffset(w=>w+1)} style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:6,padding:"5px 10px",cursor:"pointer",fontSize:14,color:T.text}}>â€º</button>
                  <button onClick={()=>setWeekOffset(0)} style={{background:T.tablehead,border:"none",borderRadius:6,padding:"5px 9px",cursor:"pointer",fontSize:11,color:T.textMuted,fontFamily:"inherit"}}>×”×™×•×</button>
                </div>
              )}
              {calMode==="month"&&(
                <div style={{display:"flex",alignItems:"center",gap:7}}>
                  <button onClick={()=>setCalMonth(({y,m})=>m===0?{y:y-1,m:11}:{y,m:m-1})} style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:6,padding:"5px 10px",cursor:"pointer",fontSize:14,color:T.text}}>â€¹</button>
                  <span style={{fontSize:13,fontWeight:600,color:T.text,minWidth:120,textAlign:"center"}}>{HEBREW_MONTHS[calMonth.m]} {calMonth.y}</span>
                  <button onClick={()=>setCalMonth(({y,m})=>m===11?{y:y+1,m:0}:{y,m:m+1})} style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:6,padding:"5px 10px",cursor:"pointer",fontSize:14,color:T.text}}>â€º</button>
                </div>
              )}
            </div>

            {calMode==="week"&&(
              <div style={{overflowX:"auto"}}>
                <table style={{width:"100%",borderCollapse:"separate",borderSpacing:4,minWidth:700}}>
                  <thead>
                    <tr>
                      <th style={{width:90,fontSize:10,color:T.textFaint,textAlign:"right",paddingBottom:4}}>××©××¨×ª/××™×§×•×</th>
                      {DAYS.map((day,di)=>{
                        const date=weekDates[di];
                        const isToday=date&&date.toDateString()===new Date().toDateString();
                        return(
                          <th key={day} style={{padding:"7px",background:isToday?T.rowSel:T.surface,borderRadius:8,border:`1px solid ${isToday?T.accent:T.border}`,textAlign:"center",fontSize:12,fontWeight:700,color:isToday?T.accent:T.text}}>
                            <div>×™×•× {dayNames[day]}</div>
                            {date&&<div style={{fontSize:9,color:T.textFaint,fontWeight:400}}>{fmtDate(date)}</div>}
                            <div style={{fontSize:9,color:"#059669",fontWeight:600,marginTop:1}}>{participants.filter(p=>p.assigned?.day===day).length} × ×‘×“×§×™×</div>
                          </th>
                        );
                      })}
                    </tr>
                  </thead>
                  <tbody>
                    {SLOTS.map(slot=>locations.map((loc,li)=>(
                      <tr key={`${slot}_${loc.id}`}>
                        {li===0&&<td rowSpan={locations.length} style={{verticalAlign:"top",paddingTop:10,fontSize:10,color:T.textFaint}}>{slot.includes("×‘×•×§×¨")?"ğŸŒ… ×‘×•×§×¨":"â˜€ï¸ ×¦×”×¨×™×™×"}</td>}
                        {DAYS.map(day=>{
                          const people=participants.filter(p=>p.assigned?.day===day&&p.assigned?.slot===slot&&p.assigned?.locationId===loc.id);
                          const isFull=people.length>=settings.perSlot;
                          const eligible=participants.filter(p=>!p.assigned&&p.availability[day]?.includes(slot));
                          const c=LOC_COLORS[li%LOC_COLORS.length];
                          return(
                            <td key={day} style={{background:isFull?c.bg:T.surface,border:`1px solid ${isFull?c.border:T.border}`,borderRadius:6,padding:6,verticalAlign:"top",minWidth:95}}>
                              <div style={{fontSize:8,color:c.text,fontWeight:700,marginBottom:2,opacity:0.7}}>{loc.name}</div>
                              {people.map(p=>(
                                <div key={p.id} style={{background:statusMeta[p.status].bg,border:`1px solid ${statusMeta[p.status].border}`,borderRadius:4,padding:"2px 6px",marginBottom:2,fontSize:10,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                                  <span style={{color:statusMeta[p.status].text,fontWeight:700}}>{p.name}</span>
                                  <button onClick={()=>clearA(p.id)} style={{background:"none",border:"none",cursor:"pointer",color:T.textFaint,fontSize:11,padding:0}}>Ã—</button>
                                </div>
                              ))}
                              {!isFull&&eligible.length>0&&(
                                <select onChange={e=>{if(e.target.value){assignP(parseInt(e.target.value),day,slot,loc.id,loc.rooms[0]||"");e.target.value="";}}} style={{width:"100%",padding:"2px 3px",border:`1px dashed ${T.border}`,borderRadius:3,fontSize:9,color:T.textFaint,background:T.surface,cursor:"pointer",fontFamily:"inherit"}}>
                                  <option value="">+{eligible.length}</option>
                                  {eligible.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
                                </select>
                              )}
                            </td>
                          );
                        })}
                      </tr>
                    )))}
                  </tbody>
                </table>
              </div>
            )}

            {calMode==="month"&&(()=>{
              const first=new Date(calMonth.y,calMonth.m,1);
              const startOff=first.getDay();
              const daysInMonth=new Date(calMonth.y,calMonth.m+1,0).getDate();
              const cells=[];
              for(let i=0;i<startOff;i++) cells.push(null);
              for(let d=1;d<=daysInMonth;d++) cells.push(d);
              return(
                <div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:3,marginBottom:4}}>
                    {["××³","×‘×³","×’×³","×“×³","×”×³","×•×³","×©×³"].map(d=>(
                      <div key={d} style={{textAlign:"center",fontSize:11,color:T.textFaint,fontWeight:700,padding:"4px 0"}}>{d}</div>
                    ))}
                  </div>
                  <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:3}}>
                    {cells.map((dayNum,ci)=>{
                      if(!dayNum) return <div key={`e${ci}`}/>;
                      const date=new Date(calMonth.y,calMonth.m,dayNum);
                      const isToday=date.toDateString()===new Date().toDateString();
                      const isSat=date.getDay()===6;
                      const heDay=["×","×‘","×’","×“","×”","×•"][date.getDay()];
                      const people=isSat?[]:participants.filter(p=>p.assigned?.day===heDay);
                      return(
                        <div key={dayNum} style={{background:isToday?T.rowSel:isSat?T.tablehead:T.surface,border:`1px solid ${isToday?T.accent:T.border}`,borderRadius:7,padding:"5px 7px",minHeight:70,opacity:isSat?0.35:1}}>
                          <div style={{fontSize:11,fontWeight:isToday?800:600,color:isToday?T.accent:T.text,marginBottom:3}}>{dayNum}</div>
                          {people.slice(0,3).map(p=>{
                            const sm=statusMeta[p.status];
                            return <div key={p.id} style={{background:sm.bg,borderRadius:3,padding:"1px 4px",fontSize:8,color:sm.text,fontWeight:600,marginBottom:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{p.name}</div>;
                          })}
                          {people.length>3&&<div style={{fontSize:8,color:T.textFaint}}>+{people.length-3}</div>}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })()}
          </div>
        )}

        {/* â•â• CHARTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab==="charts"&&(
          <div>
            {/* Chart filters */}
            <div style={{display:"flex",gap:8,marginBottom:14,alignItems:"center",background:T.surface,padding:"9px 12px",borderRadius:9,border:`1px solid ${T.border}`}}>
              <span style={{fontSize:12,color:T.textMuted,fontWeight:700}}>×¡×™× ×•×Ÿ:</span>
              <select value={chartFilter.status} onChange={e=>setChartFilter(f=>({...f,status:e.target.value}))} style={{padding:"5px 8px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:12,fontFamily:"inherit",background:T.inputBg,color:T.text}}>
                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                {Object.entries(statusMeta).map(([v,m])=><option key={v} value={v}>{m.label}</option>)}
              </select>
              <select value={chartFilter.location} onChange={e=>setChartFilter(f=>({...f,location:e.target.value}))} style={{padding:"5px 8px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:12,fontFamily:"inherit",background:T.inputBg,color:T.text}}>
                <option value="">×›×œ ×”××™×§×•××™×</option>
                {locations.map(l=><option key={l.id} value={l.id}>{l.name}</option>)}
              </select>
              {(chartFilter.status||chartFilter.location)&&<button onClick={()=>setChartFilter({status:"",location:""})} style={{background:"#FEF2F2",color:"#DC2626",border:"none",padding:"4px 8px",borderRadius:5,cursor:"pointer",fontSize:11,fontFamily:"inherit"}}>âœ• × ×§×”</button>}
            </div>

            {/* KPI Cards */}
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(140px,1fr))",gap:10,marginBottom:16}}>
              {[
                {l:"×™×¢×“",v:`${stats.byStatus.completed}/${settings.totalTarget}`,sub:`${Math.round(stats.byStatus.completed/settings.totalTarget*100)}%`,c:"#4338CA",bg:"#EEF2FF"},
                {l:L("statAssigned"),v:stats.byStatus.assigned+stats.byStatus.confirmed+stats.byStatus.completed,sub:"××ª×•×š "+stats.total,c:"#059669",bg:"#ECFDF5"},
                {l:"×××ª×™× ×™×",v:stats.byStatus.pending,sub:stats.noAvail+" ×œ×œ× ×–××™× ×•×ª",c:"#D97706",bg:"#FFF7ED"},
                {l:L("statDeclined"),v:stats.byStatus.declined,sub:"×œ×’×™×™×¡ ×—×œ×•×¤×”",c:"#DC2626",bg:"#FEF2F2"},
              ].map(k=>(
                <div key={k.l} style={{background:k.bg,borderRadius:10,padding:"12px 14px"}}>
                  <div style={{fontSize:26,fontWeight:900,color:k.c,lineHeight:1}}>{k.v}</div>
                  <div style={{fontSize:12,fontWeight:700,color:k.c,marginTop:3}}>{k.l}</div>
                  <div style={{fontSize:10,color:"#9CA3AF",marginTop:2}}>{k.sub}</div>
                </div>
              ))}
            </div>

            {/* CSS Bar Charts */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:13,marginBottom:13}}>
              {/* Status chart */}
              <div style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:12,padding:"14px 18px"}}>
                <h3 style={{margin:"0 0 12px",fontSize:13,color:T.text}}>×¡×˜×˜×•×¡×™×</h3>
                {Object.entries(statusMeta).map(([k,m])=>{
                  const v=stats.byStatus[k]||0;
                  const pct=stats.total>0?Math.round(v/stats.total*100):0;
                  return(
                    <div key={k} style={{marginBottom:8}}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                        <span style={{fontSize:11,color:T.text,display:"flex",alignItems:"center",gap:5}}>
                          <span style={{width:8,height:8,borderRadius:"50%",background:m.dot,display:"inline-block"}}/>
                          {m.label}
                        </span>
                        <span style={{fontSize:11,fontWeight:700,color:m.text}}>{v}</span>
                      </div>
                      <div style={{background:T.tablehead,borderRadius:4,height:8}}>
                        <div style={{background:m.dot,height:8,borderRadius:4,width:pct+"%",transition:"width .5s"}}/>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* By day chart */}
              <div style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:12,padding:"14px 18px"}}>
                <h3 style={{margin:"0 0 12px",fontSize:13,color:T.text}}>×©×™×‘×•×¦×™× ×œ×¤×™ ×™×•×</h3>
                {stats.byDay.map(({day,count})=>{
                  const max=Math.max(...stats.byDay.map(d=>d.count),1);
                  const pct=Math.round(count/max*100);
                  return(
                    <div key={day} style={{marginBottom:8}}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                        <span style={{fontSize:11,color:T.text}}>×™×•× {day}</span>
                        <span style={{fontSize:11,fontWeight:700,color:T.accent}}>{count}</span>
                      </div>
                      <div style={{background:T.tablehead,borderRadius:4,height:8}}>
                        <div style={{background:T.accent,height:8,borderRadius:4,width:pct+"%",transition:"width .5s"}}/>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* By location + progress */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:13}}>
              <div style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:12,padding:"14px 18px"}}>
                <h3 style={{margin:"0 0 12px",fontSize:13,color:T.text}}>×œ×¤×™ ××™×§×•×</h3>
                {stats.byLocation.map((loc,i)=>{
                  const max=Math.max(...stats.byLocation.map(l=>l.count),1);
                  const pct=Math.round(loc.count/max*100);
                  const c=LOC_COLORS[i%LOC_COLORS.length];
                  return(
                    <div key={loc.name} style={{marginBottom:8}}>
                      <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                        <span style={{fontSize:11,color:T.text,display:"flex",alignItems:"center",gap:5}}>
                          <span style={{width:8,height:8,borderRadius:"50%",background:c.dot,display:"inline-block"}}/>
                          {loc.name}
                        </span>
                        <span style={{fontSize:11,fontWeight:700,color:c.text}}>{loc.count}</span>
                      </div>
                      <div style={{background:T.tablehead,borderRadius:4,height:8}}>
                        <div style={{background:c.dot,height:8,borderRadius:4,width:pct+"%",transition:"width .5s"}}/>
                      </div>
                    </div>
                  );
                })}
              </div>

              <div style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:12,padding:"14px 18px"}}>
                <h3 style={{margin:"0 0 12px",fontSize:13,color:T.text}}>×”×ª×§×“××•×ª ({settings.totalTarget})</h3>
                {[
                  {l:L("completed"),v:stats.byStatus.completed,c:"#059669"},
                  {l:L("statConfirmed"),v:stats.byStatus.confirmed,c:"#D97706"},
                  {l:L("statAssigned"),v:stats.byStatus.assigned,c:T.accent},
                  {l:"×××ª×™× ×™×",v:stats.byStatus.pending,c:"#9CA3AF"},
                ].map(r=>(
                  <div key={r.l} style={{marginBottom:10}}>
                    <div style={{display:"flex",justifyContent:"space-between",marginBottom:3}}>
                      <span style={{fontSize:11,color:T.text}}>{r.l}</span>
                      <span style={{fontSize:11,fontWeight:700,color:r.c}}>{r.v}/{settings.totalTarget}</span>
                    </div>
                    <div style={{background:T.tablehead,borderRadius:4,height:7}}>
                      <div style={{background:r.c,height:7,borderRadius:4,width:Math.min(100,r.v/settings.totalTarget*100)+"%",transition:"width .5s"}}/>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {tab==="emails"&&(
          <div>
            <div style={{background:"#FFF7ED",border:"1px solid #FDE68A",borderRadius:10,padding:"10px 14px",marginBottom:16,fontSize:12,color:"#92400E"}}>
              ğŸ“¬ <strong>Gmail:</strong> ×œ×—×™×¦×” ×¢×œ "×©×œ×—" ×¤×•×ª×—×ª Gmail Compose ×¢× ×”× ×•×¡×— ××•×›×Ÿ. ×œ×©×œ×™×—×” ×™×©×™×¨×” ×“×¨×š API â€” ×”×’×“×¨ ×‘-<button onClick={()=>setModal("gmail")} style={{background:"none",border:"none",cursor:"pointer",color:"#D97706",fontWeight:700,fontFamily:"inherit",textDecoration:"underline"}}>×”×’×“×¨×•×ª Gmail</button>.
            </div>

            {/* â”€â”€ Manual broadcast composer â”€â”€ */}
            <div style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:12,padding:16,marginBottom:16}}>
              <h3 style={{margin:"0 0 10px",fontSize:13,color:T.text}}>âœï¸ ×”×•×“×¢×” ×—×•×¤×©×™×ª ×œ× ×‘×“×§×™×</h3>
              <ManualEmailComposer participants={participants} T={T} sendViaGmail={sendViaGmail} GS_URL={GS_URL}/>
            </div>

            {/* â”€â”€ Thank you to completed â”€â”€ */}
            {participants.filter(p=>p.status==="completed").length>0&&(
              <div style={{background:"#F0FDF4",border:"1px solid #A7F3D0",borderRadius:12,padding:16,marginBottom:16}}>
                <h3 style={{margin:"0 0 6px",fontSize:13,color:"#166534"}}>ğŸ™ ×ª×•×“×” ×œ××©×ª×ª×¤×™× ×©×”×©×œ×™××•</h3>
                <p style={{margin:"0 0 10px",fontSize:11,color:"#16a34a"}}>{participants.filter(p=>p.status==="completed").length} ××©×ª×ª×¤×™× ×”×©×œ×™××• ××ª ×”× ×™×¡×•×™</p>
                <div style={{display:"flex",flexWrap:"wrap",gap:7}}>
                  {participants.filter(p=>p.status==="completed").map(p=>(
                    <div key={p.id} style={{background:"white",border:"1px solid #A7F3D0",borderRadius:8,padding:"8px 12px",display:"flex",alignItems:"center",gap:8}}>
                      <span style={{fontSize:12,fontWeight:700,color:"#166534"}}>{p.name}</span>
                      <button onClick={()=>{
                        const subj=`×ª×•×“×” ×¢×œ ×”×©×ª×ª×¤×•×ª×š ×‘× ×™×¡×•×™ â€” ${settings.experimentName}`;
                        const body=`×©×œ×•× ${p.name},\n\n×ª×•×“×” ×¨×‘×” ×¢×œ ×”×©×ª×ª×¤×•×ª×š ×‘× ×™×¡×•×™ "${settings.experimentName}".\n×”×©×ª×ª×¤×•×ª×š ×—×©×•×‘×” ×××•×“ ×œ××—×§×¨ ×©×œ× ×• ×•×× ×• ××¢×¨×™×›×™× ××ª ×”×–××Ÿ ×•×”××××¥ ×©×”×©×§×¢×ª.\n\n×‘×‘×¨×›×”,\n${settings.currentUser}`;
                        sendViaGmail(subj,body,p.email);
                      }} style={{background:"#059669",color:"white",border:"none",borderRadius:5,padding:"3px 8px",cursor:"pointer",fontSize:10,fontFamily:"inherit",fontWeight:700}}>
                        âœ‰ï¸ ×©×œ×— ×ª×•×“×”
                      </button>
                    </div>
                  ))}
                  <button onClick={()=>{
                    const ps=participants.filter(p=>p.status==="completed"&&p.email);
                    const body=ps.map(p=>`â”€â”€â”€ ${p.name} | ${p.email} â”€â”€â”€\n× ×•×©×: ×ª×•×“×” ×¢×œ ×”×©×ª×ª×¤×•×ª×š ×‘× ×™×¡×•×™\n\n×©×œ×•× ${p.name},\n\n×ª×•×“×” ×¨×‘×” ×¢×œ ×”×©×ª×ª×¤×•×ª×š ×‘× ×™×¡×•×™ "${settings.experimentName}".\n×”×©×ª×ª×¤×•×ª×š ×—×©×•×‘×” ×××•×“ ×œ××—×§×¨ ×©×œ× ×•.\n\n×‘×‘×¨×›×”,\n${settings.currentUser}\n`).join("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n");
                    setEmailModal({subject:"×ª×•×“×” â€” ×©×œ×™×—×” ×œ×›×•×œ×",body,type:"bulk"});
                  }} style={{background:"#059669",color:"white",border:"none",borderRadius:8,padding:"8px 14px",cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit",alignSelf:"center"}}>
                    ğŸ“¨ ×©×œ×— ×ª×•×“×” ×œ×›×•×œ×
                  </button>
                </div>
              </div>
            )}

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:20}}>
              {[{title:"ğŸ“¨ ×”×–×× ×•×ª",filter:p=>p.assigned,type:"invitation",color:"#4338CA"},
                {title:"âš ï¸ ×¢×“×›×•×Ÿ ×–××™× ×•×ª",filter:p=>Object.values(p.availability).every(s=>s.length===0),type:"noAvailability",color:"#DC2626"}].map(card=>{
                const ps=participants.filter(card.filter);
                return(
                  <div key={card.title} style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:10,padding:14}}>
                    <h3 style={{margin:"0 0 4px",fontSize:13,color:T.text}}>{card.title}</h3>
                    <p style={{margin:"0 0 10px",fontSize:11,color:T.textMuted}}>{ps.length} ××©×ª×ª×¤×™×</p>
                    <button onClick={()=>{
                      const body=ps.map(p=>{const e=buildEmail(p,card.type);return `â”€â”€â”€ ${p.name} | ${p.email||"××™×Ÿ"} â”€â”€â”€\n× ×•×©×: ${e.subject}\n\n${e.body}\n`;}).join("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n");
                      setEmailModal({participant:null,subject:card.title,body,type:"bulk"});
                    }} style={{background:card.color,color:"white",border:"none",padding:"6px 13px",borderRadius:6,cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit"}}>×”×¦×’</button>
                  </div>
                );
              })}
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(210px,1fr))",gap:9}}>
              {participants.filter(p=>p.assigned).map(p=>{
                const loc=locById[p.assigned.locationId];
                const lc=locColor(p.assigned.locationId);
                return(
                  <div key={p.id} style={{background:T.surface,border:`1px solid ${T.border}`,borderRadius:9,padding:12}}>
                    <div style={{fontWeight:700,fontSize:12,color:T.text}}>{p.name}</div>
                    <div style={{fontSize:10,color:T.textMuted,margin:"2px 0 8px",display:"flex",gap:4,flexWrap:"wrap"}}>
                      <span>{dayNames[p.assigned.day]}</span>Â·
                      <span>{p.assigned.slot.includes("×‘×•×§×¨")?L("slotMorning"):L("slotAfternoon")}</span>
                      {loc&&<><span>Â·</span><span style={{background:lc.bg,color:lc.text,borderRadius:3,padding:"0 4px",fontSize:9,fontWeight:700}}>{loc.name}</span></>}
                    </div>
                    <div style={{display:"flex",gap:5}}>
                      <button onClick={()=>sendViaGmail(buildEmail(p,"invitation").subject,buildEmail(p,"invitation").body,p.email)} style={{background:"#EEF2FF",color:"#4338CA",border:"none",padding:"3px 8px",borderRadius:5,fontSize:10,cursor:"pointer",fontFamily:"inherit",fontWeight:600}}>ğŸ“¨ ×”×–×× ×”</button>
                      <button onClick={()=>sendViaGmail(buildEmail(p,"reminder").subject,buildEmail(p,"reminder").body,p.email)} style={{background:"#FFF7ED",color:"#D97706",border:"none",padding:"3px 8px",borderRadius:5,fontSize:10,cursor:"pointer",fontFamily:"inherit",fontWeight:600}}>ğŸ”” ×ª×–×›×•×¨×ª</button>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* â•â• LOCATIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {tab==="locations"&&(
          <div>
            <button onClick={()=>setModal("addLoc")} style={{background:T.accent,color:"white",border:"none",padding:"8px 15px",borderRadius:8,cursor:"pointer",fontWeight:700,fontSize:12,fontFamily:"inherit",marginBottom:14}}>{L("addLocation")}</button>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(250px,1fr))",gap:12}}>
              {locations.map((loc,i)=>{
                const c=LOC_COLORS[i%LOC_COLORS.length];
                const n=participants.filter(p=>p.assigned?.locationId===loc.id).length;
                return(
                  <div key={loc.id} style={{background:T.surface,border:`1px solid ${c.border}`,borderRadius:12,padding:15}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                      <div style={{display:"flex",alignItems:"center",gap:7}}>
                        <span style={{width:10,height:10,borderRadius:"50%",background:c.dot,display:"inline-block"}}/>
                        <span style={{fontSize:15,fontWeight:800,color:c.text}}>{loc.name}</span>
                      </div>
                      <div style={{display:"flex",gap:5}}>
                        <button onClick={()=>setModal({type:"editLoc",loc:{...loc,rooms:[...loc.rooms]}})} style={{background:c.bg,color:c.text,border:"none",padding:"3px 8px",borderRadius:5,cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:700}}>âœï¸</button>
                        <button onClick={()=>{if(window.confirm("×œ××—×•×§?")) setLocations(p=>p.filter(l=>l.id!==loc.id));}} style={{background:"#FEF2F2",color:"#DC2626",border:"none",padding:"3px 8px",borderRadius:5,cursor:"pointer",fontSize:11,fontFamily:"inherit"}}>ğŸ—‘</button>
                      </div>
                    </div>
                    <div style={{fontSize:11,color:T.textMuted,marginBottom:8}}>{n} ××©×•×‘×¦×™×</div>
                    <div style={{display:"flex",gap:5,flexWrap:"wrap"}}>
                      {loc.rooms.map(r=><span key={r} style={{background:c.bg,color:c.text,borderRadius:5,padding:"2px 7px",fontSize:11,fontWeight:600}}>{r}</span>)}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* â•â• SETTINGS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
        {modal==="settings"&&(
          <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.55)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={e=>{if(e.target===e.currentTarget)setModal(null);}}>
            <div style={{background:T.surface,borderRadius:13,padding:24,maxWidth:480,width:"100%",boxShadow:"0 24px 60px rgba(0,0,0,0.3)",maxHeight:"90vh",overflowY:"auto"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
                <h3 style={{margin:0,fontSize:15,color:T.text}}>{L("settingsTitle")}</h3>
                <button onClick={()=>setModal(null)} style={{background:"none",border:"none",fontSize:22,cursor:"pointer",color:T.textMuted}}>Ã—</button>
              </div>
              {[{k:"experimentName",l:"×©× ×”× ×™×¡×•×™"},{k:"researcherName",l:"×©× ×”×—×•×§×¨"},{k:"duration",l:"××©×š ×¡×©×Ÿ"},{k:"currentUser",l:"××©×ª××© × ×•×›×—×™ (×œ×•×’)"},{k:"baseDate",l:"×ª××¨×™×š ×”×ª×—×œ×”",type:"date"}].map(f=>(
                <div key={f.k} style={{marginBottom:11}}>
                  <label style={{display:"block",fontSize:11,color:T.textMuted,marginBottom:3,fontWeight:600}}>{f.l}</label>
                  <input type={f.type||"text"} value={settings[f.k]||""} onChange={e=>setSettings(s=>({...s,[f.k]:e.target.value}))} style={{width:"100%",padding:"7px 9px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:13,fontFamily:"inherit",boxSizing:"border-box",background:T.inputBg,color:T.text}}/>
                </div>
              ))}
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginTop:4}}>
                {[{k:"totalTarget",l:"×™×¢×“"},{k:"perSlot",l:"×‘××§×‘×™×œ"},{k:"maxPerDay",l:"××§×¡×³/×™×•×"}].map(f=>(
                  <div key={f.k}>
                    <label style={{display:"block",fontSize:11,color:T.textMuted,marginBottom:3,fontWeight:600}}>{f.l}</label>
                    <input type="number" min={1} value={settings[f.k]} onChange={e=>setSettings(s=>({...s,[f.k]:parseInt(e.target.value)||1}))} style={{width:"100%",padding:"7px 9px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:13,fontFamily:"inherit",boxSizing:"border-box",background:T.inputBg,color:T.text}}/>
                  </div>
                ))}
              </div>
              <div style={{marginTop:14,borderTop:`1px solid ${T.border}`,paddingTop:12,display:"flex",gap:8}}>
                <button onClick={()=>{const blob=new Blob([JSON.stringify({participants,locations,settings,changelog},null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="experiment_backup.json";a.click();}} style={{background:T.accent,color:"white",border:"none",padding:"7px 13px",borderRadius:6,cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit"}}>â¬‡ï¸ ×™×™×¦× JSON</button>
                <button onClick={()=>{const i=document.createElement("input");i.type="file";i.accept=".json";i.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(d.participants)setParticipants(d.participants);if(d.locations)setLocations(d.locations);if(d.settings)setSettings(d.settings);if(d.changelog)setChangelog(d.changelog);showToast("âœ… ×©×•×—×–×¨");}catch{showToast("×©×’×™××”","error");}};r.readAsText(f);};i.click();}} style={{background:T.tablehead,color:T.accent,border:`1px solid ${T.border}`,padding:"7px 13px",borderRadius:6,cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit"}}>â¬†ï¸ ×™×‘×•× JSON</button>
              </div>
            </div>
          </div>
        )}
      </div>
      </div>

      {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}

      {/* Add/Edit participant */}
      {modal==="addEdit"&&editP&&<ParticipantModal p={editP} locations={locations} T={T} L={L} onSave={saveParticipant} onClose={()=>{setModal(null);setEditP(null);}}/>}

      {/* Location add/edit */}
      {(modal==="addLoc"||modal?.type==="editLoc")&&(
        <LocModal loc={modal?.type==="editLoc"?modal.loc:{id:null,name:"",rooms:[]}} T={T}
          onSave={l=>{if(l.id){setLocations(p=>p.map(x=>x.id===l.id?l:x));}else{setLocations(p=>[...p,{...l,id:newId(locations)}]);}setModal(null);}}
          onClose={()=>setModal(null)}/>
      )}

      {/* Help */}
      {modal==="help"&&(
        <ModalShell title={L("menuHelp")} T={T} onClose={()=>setModal(null)} wide>
          <div style={{fontSize:13,lineHeight:1.8,color:T.text}}>
            {[
              ["ğŸ“‹ ×˜××‘ ×©×™×‘×•×¦×™×","×”×˜×‘×œ×” ×”×¨××©×™×ª. ×‘×—×¨ × ×‘×“×§×™× ×¢× ×”×¦'×§×‘×•×§×¡ ×•××– ×”×¤×¢×œ ×¤×¢×•×œ×•×ª. × ×™×ª×Ÿ ×œ××™×™×Ÿ ×›×œ ×¢××•×“×” ×‘×œ×—×™×¦×” ×¢×œ ×”×›×•×ª×¨×ª. ×”×¡×™× ×•×Ÿ ×‘×©×•×¨×” ×”×¢×œ×™×•× ×” ×¤×•×¢×œ ×‘×–××Ÿ ×××ª."],
              ["âš¡ ×©×™×‘×•×¥ ××•×˜×•××˜×™","×›×©××™×Ÿ ×‘×—×™×¨×” â€” ××©×‘×¥ ××ª ×›×•×œ×. ×›×©×™×© ×‘×—×™×¨×” â€” ××©×‘×¥ ×¨×§ ××ª ×”× ×‘×—×¨×™×. ×”××œ×’×•×¨×™×ª× ××§×©×” ×œ×©×™×‘×•×¥ ×§×•×“× (×”×›×™ ××•×’×‘×œ×™× ×‘×–××™× ×•×ª)."],
              ["ğŸ—‘ × ×™×§×•×™ ×©×™×‘×•×¦×™×","×¤×•×¢×œ ×¨×§ ×›×©×™×© × ×‘×“×§×™× × ×‘×—×¨×™× â€” ×× ×§×” ××ª ×©×™×‘×•×¦×. ×œ×œ× ×‘×—×™×¨×” â€” ×”×¤×§×“ ×œ× ××•×¦×’."],
              [L("btnImportCSV"),"×™×™×¦× ××’×•×’×œ ×¤×•×¨××¡ ×›-CSV. ×”××¢×¨×›×ª ××–×”×” ×›×¤×•×œ×™× ×œ×¤×™ ××™××™×™×œ/×˜×œ×¤×•×Ÿ/×©× ×•×©×•××œ×ª ××” ×œ×¢×©×•×ª."],
              [L("tabEmails"),"×œ×—×™×¦×” ×¢×œ '×©×œ×—' ×¤×•×ª×—×ª Gmail Compose ×¢× ×”× ×•×¡×—. × ×™×ª×Ÿ ×œ×¢×¨×•×š ×œ×¤× ×™ ×”×©×œ×™×—×”."],
              [L("tabCalendar"),"×©×‘×•×¢×™ ×¢× × ×™×•×•×˜ â€¹ â€º ×‘×™×Ÿ ×©×‘×•×¢×•×ª. ×—×•×“×©×™ ××¦×™×’ ×›×œ ×”× ×‘×“×§×™× ×”××©×•×‘×¦×™× ×¢×œ ×”×œ×•×—."],
              [L("tabCharts"),"× ×™×ª×Ÿ ×œ×¡× ×Ÿ ××ª ×”×’×¨×¤×™× ×œ×¤×™ ×¡×˜×˜×•×¡ ×•××™×§×•×. ×”×’×¨×¤×™× ××ª×¢×“×›× ×™× ×‘×–××Ÿ ×××ª."],
              ["ğŸ’¾ ×’×™×‘×•×™","×™×™×¦× JSON ××”×’×“×¨×•×ª â†’ ×©×œ×— ×œ×©×•×ª×£ â†’ ×”×•× ××™×™×‘×. ×›×œ ×”× ×ª×•× ×™× ×©××•×¨×™× ×‘×“×¤×“×¤×Ÿ."],
            ].map(([title,desc])=>(
              <div key={title} style={{marginBottom:12,padding:"8px 12px",background:T.tablehead,borderRadius:8}}>
                <div style={{fontWeight:700,marginBottom:3}}>{title}</div>
                <div style={{color:T.textMuted,fontSize:12}}>{desc}</div>
              </div>
            ))}
          </div>
        </ModalShell>
      )}

      {/* Changelog */}
      {modal==="changelog"&&(
        <ModalShell title={L("menuChangelog")} T={T} onClose={()=>setModal(null)} wide>
          {changelog.length===0?<p style={{color:T.textMuted,textAlign:"center"}}>××™×Ÿ ×©×™× ×•×™×™× ×¢×“×™×™×Ÿ</p>:(
            <div style={{maxHeight:450,overflowY:"auto"}}>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
                <thead>
                  <tr style={{background:T.tablehead}}>
                    {["×–××Ÿ","××©×ª××©","×¤×¢×•×œ×”","×¤×¨×˜×™×"].map(h=><th key={h} style={{padding:"7px 10px",textAlign:"right",color:T.textMuted,fontWeight:700,borderBottom:`1px solid ${T.border}`}}>{h}</th>)}
                  </tr>
                </thead>
                <tbody>
                  {changelog.map((e,i)=>(
                    <tr key={e.id} style={{borderBottom:`1px solid ${T.border}`,background:i%2===0?T.surface:T.tablehead}}>
                      <td style={{padding:"6px 10px",whiteSpace:"nowrap",color:T.textFaint}}>{tsToStr(e.ts)}</td>
                      <td style={{padding:"6px 10px",fontWeight:600,color:T.accent}}>{e.user}</td>
                      <td style={{padding:"6px 10px",fontWeight:600,color:T.text}}>{e.action}</td>
                      <td style={{padding:"6px 10px",color:T.textMuted}}>{e.details}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
          <div style={{marginTop:10,textAlign:"left"}}>
            <button onClick={()=>{if(window.confirm("×œ× ×§×•×ª ××ª ×”×œ×•×’?")) setChangelog([]);}} style={{background:"#FEF2F2",color:"#DC2626",border:"none",padding:"5px 12px",borderRadius:6,cursor:"pointer",fontSize:11,fontFamily:"inherit"}}>{lang==="en"?"ğŸ—‘ Clear log":"ğŸ—‘ × ×§×” ×œ×•×’"}</button>
          </div>
        </ModalShell>
      )}

      {/* Gmail settings */}
      {modal==="gmail"&&(
        <ModalShell title="âœ‰ï¸ ×”×’×“×¨×•×ª Gmail" T={T} onClose={()=>setModal(null)}>
          <div style={{fontSize:13,color:T.text,lineHeight:1.8}}>
            <div style={{background:"#FFF7ED",border:"1px solid #FDE68A",borderRadius:8,padding:"10px 14px",marginBottom:14,fontSize:12,color:"#92400E"}}>
              <strong>âš ï¸ ××’×‘×œ×ª Artifact:</strong> ×©×œ×™×—×” ×™×©×™×¨×” ×“×¨×š Gmail API ××™× ×” ××¤×©×¨×™×ª ×‘×ª×•×š Claude artifact ×‘×’×œ×œ ××’×‘×œ×•×ª OAuth.
              <br/>×”×¤×ª×¨×•×Ÿ ×”× ×•×›×—×™: ×œ×—×™×¦×ª "×©×œ×—" ×¤×•×ª×—×ª Gmail Compose ×¢× ×”× ×•×¡×— â€” ×‘×œ×—×™×¦×” × ×•×¡×¤×ª ×”×•× × ×©×œ×—.
            </div>
            <p style={{margin:"0 0 10px",fontWeight:700}}>×œ×©×œ×™×—×” ×™×©×™×¨×” â€” 2 ××¤×©×¨×•×™×•×ª:</p>
            <div style={{background:T.tablehead,borderRadius:8,padding:"10px 14px",marginBottom:10}}>
              <p style={{margin:"0 0 5px",fontWeight:600}}>××¤×©×¨×•×ª 1: Replit + Gmail API</p>
              <p style={{margin:0,fontSize:12,color:T.textMuted}}>×”×¢×œ×” ××ª ×”×§×•×“ ×œ-Replit, ×”×•×¡×£ Gmail API credentials, ×•×ª×•×›×œ ×œ×©×œ×•×— ×™×©×™×¨×•×ª ××”××¤×œ×™×§×¦×™×”.</p>
            </div>
            <div style={{background:T.tablehead,borderRadius:8,padding:"10px 14px"}}>
              <p style={{margin:"0 0 5px",fontWeight:600}}>××¤×©×¨×•×ª 2: Google Apps Script</p>
              <p style={{margin:0,fontSize:12,color:T.textMuted}}>×“×¨×š ×”-Google Sheets backend â€” Apps Script ×™×›×•×œ ×œ×©×œ×•×— ××™×™×œ×™× ×‘-Gmail API ×™×©×™×¨×•×ª.</p>
            </div>
            <div style={{marginTop:14,padding:"10px 14px",background:T.rowSel,borderRadius:8}}>
              <p style={{margin:"0 0 6px",fontWeight:700,color:T.accent}}>×›×¨×’×¢ â€” ×”×’×“×¨ ×›×ª×•×‘×ª ×©×•×œ×—:</p>
              <input value={settings.gmailSender||""} onChange={e=>setSettings(s=>({...s,gmailSender:e.target.value}))} placeholder="your@gmail.com" style={{width:"100%",padding:"7px 9px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:12,fontFamily:"inherit",boxSizing:"border-box",background:T.inputBg,color:T.text}}/>
            </div>
          </div>
        </ModalShell>
      )}

      {/* About */}
      {modal==="about"&&(
        <ModalShell title="â„¹ï¸ ××•×“×•×ª" T={T} onClose={()=>setModal(null)}>
          <div style={{textAlign:"center",padding:"10px 0",color:T.text}}>
            <div style={{fontSize:40,marginBottom:8}}>ğŸ§ª</div>
            <h2 style={{margin:"0 0 4px",fontSize:18}}>{L("appName")}</h2>
            <div style={{fontSize:13,color:T.textMuted,marginBottom:16}}>×’×¨×¡×” {APP_VERSION}</div>
            <div style={{fontSize:12,color:T.textMuted,lineHeight:1.7}}>
              <p>××¢×¨×›×ª ×œ× ×™×”×•×œ ×•×¡×™××•× ××©×ª×ª×¤×™× ×‘××—×§×¨</p>
              <p>×›×œ ×”× ×ª×•× ×™× ×©××•×¨×™× ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ</p>
              <p>×œ×©×™×ª×•×£ ×‘×–××Ÿ ×××ª â€” ×¨××” ××“×¨×™×š Google Sheets</p>
            </div>
            <div style={{marginTop:16,padding:"8px 14px",background:T.tablehead,borderRadius:8,fontSize:11,color:T.textFaint}}>
              × ×‘× ×” ×¢× React â€¢ {new Date().getFullYear()}
            </div>
          </div>
        </ModalShell>
      )}

      {/* Bulk email modal */}
      {modal==="bulkEmail"&&(
        <BulkEmailModal
          targets={selList.filter(p=>p.email&&p.assigned)}
          buildEmail={buildEmail}
          T={T}
          onClose={()=>{setModal(null);setSelected(new Set());}}
          onDone={(count,type)=>{addLog("×©×œ×™×—×ª ××™×™×œ×™×",`× ×©×œ×—×• ${count} ××™×™×œ×™× (${type})`);}}
        />
      )}

      {/* Duplicate resolution */}
      {dupModal&&(
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
          <div style={{background:T.surface,borderRadius:16,padding:24,maxWidth:600,width:"100%",boxShadow:"0 24px 60px rgba(0,0,0,0.35)",maxHeight:"90vh",overflowY:"auto"}}>
            
            {/* Header */}
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
              <div>
                <h3 style={{margin:0,fontSize:16,color:T.text}}>âš ï¸ × ××¦× ×›×¤×•×œ</h3>
                <div style={{fontSize:11,color:T.textMuted,marginTop:2}}>
                  {dupModal.index+1} {L("dupOf")} {dupModal.conflicts.length} {L("dupConflicts")}
                </div>
              </div>
              <div style={{display:"flex",gap:4}}>
                {dupModal.conflicts.map((_,i)=>(
                  <div key={i} style={{width:8,height:8,borderRadius:"50%",background:i===dupModal.index?T.accent:T.border}}/>
                ))}
              </div>
            </div>

            {(()=>{
              const {incoming, existing, reason} = dupModal.conflicts[dupModal.index];
              const ex = existing[0];
              
              // Field-by-field comparison
              const fields = [
                {label:L("colName"),a:incoming.name,  b:ex.name},
                {label:L("colEmail"),a:incoming.email, b:ex.email},
                {label:"×˜×œ×¤×•×Ÿ",     a:incoming.phone, b:ex.phone},
                {label:L("colAge"), a:incoming.age,   b:ex.age},
                {label:L("colGender"),a:incoming.gender,b:ex.gender},
                {label:"× ×•×¡×£",      a:incoming.importedAt?tsToStr(incoming.importedAt):"",b:ex.importedAt?tsToStr(ex.importedAt):""},
                {label:"×¡×˜×˜×•×¡",     a:"",             b:statusMeta[ex.status]?.label||ex.status},
                {label:"×©×™×‘×•×¥",     a:"",             b:ex.assigned?`${L("dayPrefix")}${dayNames[ex.assigned.day]} ${ex.assigned.slot?.includes("×‘×•×§×¨")?L("slotMorning"):L("slotAfternoon")}`:"××™×Ÿ"},
              ];

              return (
                <>
                  {/* Match reason badge */}
                  <div style={{background:"#FFF7ED",border:"1px solid #FDE68A",borderRadius:6,padding:"5px 10px",fontSize:11,color:"#92400E",marginBottom:14,display:"inline-flex",alignItems:"center",gap:5}}>
                    <span>ğŸ”</span> ×–×•×”×” ×›×¤×•×œ ×œ×¤×™: <strong>{reason}</strong>
                  </div>

                  {/* Side-by-side comparison */}
                  <div style={{display:"grid",gridTemplateColumns:"80px 1fr 1fr",gap:1,borderRadius:8,overflow:"hidden",border:`1px solid ${T.border}`,marginBottom:16,fontSize:12}}>
                    {/* Header row */}
                    <div style={{background:T.tablehead,padding:"7px 10px",fontWeight:700,fontSize:11,color:T.textMuted}}></div>
                    <div style={{background:"#EEF2FF",padding:"7px 10px",fontWeight:700,color:"#4338CA",textAlign:"center"}}>ğŸ“¥ ××”×§×•×‘×¥ (×—×“×©)</div>
                    <div style={{background:"#F0FDF4",padding:"7px 10px",fontWeight:700,color:"#059669",textAlign:"center"}}>âœ… ×‘××¢×¨×›×ª (×§×™×™×)</div>
                    
                    {fields.map(({label,a,b})=>{
                      const diff = a && b && a!==b;
                      return (
                        <React.Fragment key={label}>
                          <div style={{background:T.tablehead,padding:"6px 10px",fontWeight:600,color:T.textMuted,fontSize:11,display:"flex",alignItems:"center"}}>{label}</div>
                          <div style={{background:diff?"#FEF3C7":"#EEF2FF22",padding:"6px 10px",color:T.text,borderTop:`1px solid ${T.border}22`}}>{a||<span style={{color:T.textFaint}}>â€”</span>}</div>
                          <div style={{background:diff?"#FEF3C7":"#F0FDF422",padding:"6px 10px",color:T.text,borderTop:`1px solid ${T.border}22`}}>{b||<span style={{color:T.textFaint}}>â€”</span>}</div>
                        </React.Fragment>
                      );
                    })}
                  </div>

                  {/* Action buttons */}
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
                    {[
                      {a:"skip",    icon:"â­", label:L("dupSkipDesc"),      desc:L("dupSkipSub"),    color:"#6B7280", bg:T.tablehead},
                      {a:"merge",   icon:"ğŸ”€", label:L("dupMergeDesc"), desc:L("dupMergeSub"), color:"#D97706", bg:"#FFF7ED"},
                      {a:"replace", icon:"ğŸ”", label:L("dupReplaceDesc"),        desc:L("dupReplaceSub"),       color:"#DC2626", bg:"#FEF2F2"},
                      {a:"add",     icon:"â•", label:L("dupAddDesc"),       desc:L("dupAddSub"),                  color:"#059669", bg:"#F0FDF4"},
                    ].map(b=>(
                      <button key={b.a} onClick={()=>resolveDup(b.a)} style={{
                        background:b.bg, color:b.color, border:`1.5px solid ${b.color}33`,
                        padding:"10px 12px", borderRadius:9, cursor:"pointer",
                        fontFamily:"inherit", textAlign:"right",
                      }}>
                        <div style={{fontSize:13,fontWeight:700}}>{b.icon} {b.label}</div>
                        <div style={{fontSize:10,opacity:0.75,marginTop:2}}>{b.desc}</div>
                      </button>
                    ))}
                  </div>

                  {/* Apply to all */}
                  {dupModal.conflicts.length > 1 && (
                    <div style={{marginTop:12,display:"flex",gap:6,justifyContent:"center",flexWrap:"wrap"}}>
                      <span style={{fontSize:11,color:T.textMuted,alignSelf:"center"}}>×”×—×œ ×¢×œ ×›×œ ×”×›×¤×•×œ×™×:</span>
                      {["skip","merge","replace"].map(a=>(
                        <button key={a} onClick={()=>{
                          const actions={skip:"â­ ×“×œ×’",merge:"ğŸ”€ ××–×’",replace:"ğŸ” ×”×—×œ×£"};
                          const conflicts=dupModal.conflicts;
                          const resolved=[];
                          let updatedParts=[...participants];
                          conflicts.forEach(({incoming,existing})=>{
                            resolved.push({action:a,name:incoming.name,p:incoming});
                            if(a==="replace") updatedParts=updatedParts.map(p=>p.id===existing[0].id?{...incoming,id:p.id}:p);
                            else if(a==="merge") updatedParts=updatedParts.map(p=>p.id===existing[0].id?{...p,availability:incoming.availability,email:incoming.email||p.email,phone:incoming.phone||p.phone}:p);
                          });
                          const toAdd=[...dupModal.newOnes];
                          setParticipants([...updatedParts,...toAdd]);
                          setDupModal(null);
                          addLog("×™×‘×•× CSV",`×”×•×—×œ "${a}" ×¢×œ ${conflicts.length} ×›×¤×•×œ×™×`);
                          setImportStatus({state:"ok",msg:`âœ… ×˜×•×¤×œ â€” ${toAdd.length} × ×•×¡×¤×•, ${conflicts.length} ×›×¤×•×œ×™×`});
                          setTimeout(()=>setImportStatus(null),4000);
                        }} style={{background:T.tablehead,color:T.text,border:`1px solid ${T.border}`,padding:"4px 10px",borderRadius:6,cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:600}}>
                          {{skip:L("dupSkipAll"),merge:L("dupMergeAll"),replace:L("dupReplaceAll")}[a]}
                        </button>
                      ))}
                    </div>
                  )}
                </>
              );
            })()}
          </div>
        </div>
      )}

      {/* Email modal */}
      {emailModal&&(
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={e=>{if(e.target===e.currentTarget)setEmailModal(null);}}>
          <div style={{background:T.surface,borderRadius:12,padding:20,maxWidth:540,width:"100%",maxHeight:"80vh",display:"flex",flexDirection:"column",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <h3 style={{margin:0,fontSize:13,color:T.text}}>{emailModal.subject}</h3>
              <button onClick={()=>setEmailModal(null)} style={{background:"none",border:"none",fontSize:20,cursor:"pointer",color:T.textMuted}}>Ã—</button>
            </div>
            <textarea value={emailModal.body} onChange={e=>setEmailModal(p=>({...p,body:e.target.value}))} style={{flex:1,minHeight:200,padding:"8px",border:`1px solid ${T.border}`,borderRadius:5,fontSize:12,fontFamily:"inherit",resize:"vertical",lineHeight:1.65,background:T.inputBg,color:T.text}}/>
            <div style={{display:"flex",gap:7,marginTop:10,justifyContent:"flex-end"}}>
              <button onClick={()=>navigator.clipboard.writeText(emailModal.body).then(()=>showToast("×”×•×¢×ª×§ âœ“"))} style={{background:T.accent,color:"white",border:"none",padding:"7px 13px",borderRadius:6,cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit"}}>ğŸ“‹ ×”×¢×ª×§</button>
            </div>
          </div>
        </div>
      )}

      {/* Toast */}
      {/* Per-row email dropdown */}
      {rowEmailMenu&&(
        <>
          <div style={{position:"fixed",inset:0,zIndex:1400}} onClick={()=>setRowEmailMenu(null)}/>
          <div onClick={e=>e.stopPropagation()} style={{position:"fixed",[lang==="en"?"left":"right"]:rowEmailMenu.x,top:rowEmailMenu.y,background:T.surface,border:`1px solid ${T.border}`,borderRadius:10,boxShadow:"0 8px 32px rgba(0,0,0,0.2)",zIndex:1500,minWidth:210,overflow:"hidden"}}>
            {(()=>{
              const p=rowEmailMenu.p;
              const opts=[
                {type:"invitation",icon:"ğŸ“¨",he:"×”×–×× ×” ×œ× ×™×¡×•×™",en:"Invitation",show:!!p.assigned},
                {type:"reminder",  icon:"ğŸ””",he:"×ª×–×›×•×¨×ª",en:"Reminder",show:!!p.assigned},
                {type:"noAvailability",icon:"âš ï¸",he:"×‘×§×©×ª ×¢×“×›×•×Ÿ ×–××™× ×•×ª",en:"Availability request",show:true},
                {type:"thanks",    icon:"ğŸ™",he:"×ª×•×“×” (×”×©×œ××ª × ×™×¡×•×™)",en:"Thank you",show:p.status==="completed"},
              ].filter(o=>o.show);
              return opts.map(opt=>(
                <button key={opt.type} onClick={()=>{
                  let subj,body;
                  if(opt.type==="thanks"){
                    subj=`×ª×•×“×” ×¢×œ ×”×©×ª×ª×¤×•×ª×š â€“ ${settings.experimentName}`;
                    body=`×©×œ×•× ${p.name},\n\n×ª×•×“×” ×¨×‘×” ×¢×œ ×”×©×ª×ª×¤×•×ª×š ×‘× ×™×¡×•×™ "${settings.experimentName}"!\n\n×‘×‘×¨×›×”,\n${settings.currentUser}`;
                  } else {
                    const e=buildEmail(p,opt.type);subj=e.subject;body=e.body;
                  }
                  sendViaGmail(subj,body,p.email);
                  setRowEmailMenu(null);
                }} style={{display:"flex",alignItems:"center",gap:9,width:"100%",textAlign:"right",padding:"10px 14px",border:"none",background:"none",cursor:"pointer",fontSize:12,fontFamily:"inherit",color:T.text,borderBottom:`1px solid ${T.border}`}}>
                  <span style={{fontSize:16}}>{opt.icon}</span>
                  <span>{lang==="en"?opt.en:opt.he}</span>
                </button>
              ));
            })()}
          </div>
        </>
      )}

      {/* Excel-style column filter dropdown */}
      {colMenu&&(
        <>
          <div style={{position:"fixed",inset:0,zIndex:1400}} onClick={()=>setColMenu(null)}/>
          <div style={{position:"fixed",[lang==="en"?"left":"right"]:colMenu.x,top:colMenu.y,background:T.surface,border:`1px solid ${T.border}`,borderRadius:9,boxShadow:"0 8px 32px rgba(0,0,0,0.2)",zIndex:1500,minWidth:180,maxHeight:320,overflowY:"auto",padding:"6px 0"}} onClick={e=>e.stopPropagation()}>
            <div style={{padding:"6px 12px",borderBottom:`1px solid ${T.border}`,display:"flex",gap:6}}>
              <button onClick={()=>{toggleSort(colMenu.col);}} style={{flex:1,background:T.tablehead,border:`1px solid ${T.border}`,borderRadius:5,padding:"4px 0",cursor:"pointer",fontSize:11,fontFamily:"inherit",color:T.text,fontWeight:sortCol===colMenu.col&&sortDir==="asc"?800:400}}>
                â†‘ ×¡×“×¨ ×¢×•×œ×”
              </button>
              <button onClick={()=>{if(sortCol===colMenu.col)setSortDir("desc");else{setSortCol(colMenu.col);setSortDir("desc");}}} style={{flex:1,background:T.tablehead,border:`1px solid ${T.border}`,borderRadius:5,padding:"4px 0",cursor:"pointer",fontSize:11,fontFamily:"inherit",color:T.text,fontWeight:sortCol===colMenu.col&&sortDir==="desc"?800:400}}>
                â†“ ×¡×“×¨ ×™×•×¨×“
              </button>
            </div>
            <div style={{padding:"5px 12px",borderBottom:`1px solid ${T.border}`}}>
              <label style={{display:"flex",alignItems:"center",gap:7,cursor:"pointer",fontSize:12,color:T.text}}>
                <input type="checkbox"
                  checked={(filters[colMenu.fkey]||[]).length===0}
                  onChange={()=>setFilters(f=>({...f,[colMenu.fkey]:[]}))}
                  style={{cursor:"pointer"}}/>
                <strong>×”×›×œ</strong>
              </label>
            </div>
            {colMenu.options.map(opt=>{
              const active=(filters[colMenu.fkey]||[]).includes(opt.v);
              return(
                <div key={opt.v} style={{padding:"4px 12px"}}>
                  <label style={{display:"flex",alignItems:"center",gap:7,cursor:"pointer",fontSize:12,color:T.text}}>
                    <input type="checkbox" checked={active} onChange={()=>{
                      setFilters(f=>{
                        const cur=f[colMenu.fkey]||[];
                        return {...f,[colMenu.fkey]:active?cur.filter(x=>x!==opt.v):[...cur,opt.v]};
                      });
                    }} style={{cursor:"pointer"}}/>
                    {opt.l}
                    <span style={{marginRight:"auto",fontSize:10,color:T.textFaint}}>
                      ({participants.filter(p=>{
                        const fkey=colMenu.fkey;
                        if(fkey==="status") return p.status===opt.v;
                        if(fkey==="gender") return p.gender===opt.v;
                        if(fkey==="location") return String(p.assigned?.locationId||"")===opt.v;
                        if(fkey==="day") return p.assigned?.day===opt.v;
                        if(fkey==="slot") return (p.assigned?.slot||"").includes(opt.v)||Object.values(p.availability||{}).flat().some(a=>a.includes(opt.v));
                        if(fkey==="locPref") return (p.locPref||[]).map(String).includes(opt.v);
                        if(fkey==="age") return String(p.age||"")===opt.v;
                        return false;
                      }).length})
                    </span>
                  </label>
                </div>
              );
            })}
            {(filters[colMenu.fkey]||[]).length>0&&(
              <div style={{padding:"6px 12px",borderTop:`1px solid ${T.border}`,marginTop:4}}>
                <button onClick={()=>setFilters(f=>({...f,[colMenu.fkey]:[]}))} style={{width:"100%",background:"#FEF2F2",color:"#DC2626",border:"none",borderRadius:5,padding:"5px 0",cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:700}}>
                  âœ• × ×§×” ×¡×™× ×•×Ÿ ×¢××•×“×”
                </button>
              </div>
            )}
          </div>
        </>
      )}

      {toast&&<div style={{position:"fixed",bottom:20,right:22,background:toast.type==="error"?"#DC2626":"#1E1B4B",color:"white",padding:"10px 16px",borderRadius:8,fontSize:13,fontWeight:600,zIndex:3000,boxShadow:"0 8px 24px rgba(0,0,0,0.25)",animation:"slideUp .25s ease"}}>{toast.msg}</div>}
      <style>{`@keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}`}</style>
    </div>
  );
}

// â”€â”€ Modal shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ManualEmailComposer({participants, T, sendViaGmail, GS_URL}) {
  const [subject, setSubject] = React.useState("");
  const [body, setBody] = React.useState("");
  const [targets, setTargets] = React.useState("all"); // "all" | "assigned" | "selected"
  const [selected, setSelected] = React.useState(new Set());
  const [aiLoading, setAiLoading] = React.useState(false);
  const [aiMode, setAiMode] = React.useState(null); // "rewrite" | "proofread"

  const getRecipients = () => {
    if(targets==="all") return participants.filter(p=>p.email);
    if(targets==="assigned") return participants.filter(p=>p.email&&p.assigned);
    if(targets==="completed") return participants.filter(p=>p.email&&p.status==="completed");
    return participants.filter(p=>p.email&&selected.has(p.id));
  };

  const callAI = async (mode) => {
    if(!body.trim()) return;
    setAiLoading(true); setAiMode(mode);
    try {
      const prompt = mode==="rewrite"
        ? `×©×›×ª×‘ ××ª ×”×”×•×“×¢×” ×”×‘××” ×‘×¦×•×¨×” ×‘×¨×•×¨×” ×•××§×¦×•×¢×™×ª ×‘×¢×‘×¨×™×ª, ×©××•×¨ ×¢×œ ×›×•×•× ×ª ×”×”×•×“×¢×”:\n\n${body}`
        : `×‘×“×•×§ ×•×ª×§×Ÿ ×©×’×™××•×ª ×›×ª×™×‘ ×•×“×§×“×•×§ ×‘×”×•×“×¢×” ×”×‘××” ×‘×¢×‘×¨×™×ª, ×”×—×–×¨ ×¨×§ ××ª ×”×˜×§×¡×˜ ×”××ª×•×§×Ÿ:\n\n${body}`;
      const res = await fetch("https://api.anthropic.com/v1/messages", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:prompt}]})
      });
      const data = await res.json();
      const text = data.content?.find(c=>c.type==="text")?.text||"";
      if(text) setBody(text);
    } catch(e) { console.error(e); }
    setAiLoading(false); setAiMode(null);
  };

  const recipients = getRecipients();

  return (
    <div>
      {/* Target selector */}
      <div style={{display:"flex",gap:6,marginBottom:10,flexWrap:"wrap"}}>
        {[{v:"all",l:`×›×•×œ× (${participants.filter(p=>p.email).length})`},
          {v:"assigned",l:`××©×•×‘×¦×™× (${participants.filter(p=>p.email&&p.assigned).length})`},
          {v:"completed",l:`×”×©×œ×™××• (${participants.filter(p=>p.email&&p.status==="completed").length})`},
          {v:"selected",l:"×‘×—×™×¨×” ×™×“× ×™×ª"},
        ].map(opt=>(
          <button key={opt.v} onClick={()=>setTargets(opt.v)} style={{
            background:targets===opt.v?"#4338CA":T.tablehead,
            color:targets===opt.v?"white":T.textMuted,
            border:`1px solid ${targets===opt.v?"#4338CA":T.border}`,
            borderRadius:6,padding:"4px 10px",cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:targets===opt.v?700:400
          }}>{opt.l}</button>
        ))}
      </div>

      {/* Manual selection */}
      {targets==="selected"&&(
        <div style={{maxHeight:120,overflowY:"auto",border:`1px solid ${T.border}`,borderRadius:7,padding:6,marginBottom:10,display:"flex",flexWrap:"wrap",gap:4}}>
          {participants.filter(p=>p.email).map(p=>(
            <button key={p.id} onClick={()=>setSelected(s=>{const n=new Set(s);n.has(p.id)?n.delete(p.id):n.add(p.id);return n;})} style={{
              background:selected.has(p.id)?"#EEF2FF":T.tablehead,
              color:selected.has(p.id)?"#4338CA":T.textMuted,
              border:`1px solid ${selected.has(p.id)?"#C7D4FF":T.border}`,
              borderRadius:5,padding:"2px 8px",cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:selected.has(p.id)?700:400
            }}>{selected.has(p.id)?"âœ“ ":""}{p.name}</button>
          ))}
        </div>
      )}

      {/* Subject */}
      <input value={subject} onChange={e=>setSubject(e.target.value)} placeholder="× ×•×©× ×”×”×•×“×¢×”..."
        style={{width:"100%",padding:"7px 10px",border:`1px solid ${T.border}`,borderRadius:7,fontSize:12,fontFamily:"inherit",background:T.inputBg,color:T.text,boxSizing:"border-box",marginBottom:8}}/>

      {/* Body */}
      <textarea value={body} onChange={e=>setBody(e.target.value)} placeholder="×›×ª×•×‘ ××ª ×”×”×•×“×¢×” ×›××Ÿ..."
        rows={5} style={{width:"100%",padding:"8px 10px",border:`1px solid ${T.border}`,borderRadius:7,fontSize:12,fontFamily:"inherit",background:T.inputBg,color:T.text,resize:"vertical",boxSizing:"border-box",lineHeight:1.6}}/>

      {/* AI + Send buttons */}
      <div style={{display:"flex",gap:6,marginTop:8,flexWrap:"wrap",alignItems:"center"}}>
        <button onClick={()=>callAI("proofread")} disabled={aiLoading||!body.trim()} style={{
          background:aiMode==="proofread"?"#7C3AED":"#EDE9FE",color:aiMode==="proofread"?"white":"#5B21B6",
          border:"none",borderRadius:6,padding:"5px 12px",cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:700,
          opacity:aiLoading&&aiMode!=="proofread"?0.5:1
        }}>
          {aiLoading&&aiMode==="proofread"?"â³ ...":L("btnProofread")}
        </button>
        <button onClick={()=>callAI("rewrite")} disabled={aiLoading||!body.trim()} style={{
          background:aiMode==="rewrite"?"#7C3AED":"#EDE9FE",color:aiMode==="rewrite"?"white":"#5B21B6",
          border:"none",borderRadius:6,padding:"5px 12px",cursor:"pointer",fontSize:11,fontFamily:"inherit",fontWeight:700,
          opacity:aiLoading&&aiMode!=="rewrite"?0.5:1
        }}>
          {aiLoading&&aiMode==="rewrite"?"â³ ...":L("btnRewrite")}
        </button>
        <div style={{marginRight:"auto",fontSize:11,color:T.textMuted}}>{recipients.length} × ××¢× ×™×</div>
        <button onClick={()=>{
          if(!subject.trim()||!body.trim()||recipients.length===0) return;
          recipients.forEach(p=>sendViaGmail(subject, `×©×œ×•× ${p.name},\n\n${body}`, p.email));
        }} disabled={!subject.trim()||!body.trim()||recipients.length===0} style={{
          background:subject&&body&&recipients.length>0?"#059669":"#9CA3AF",
          color:"white",border:"none",borderRadius:6,padding:"5px 14px",cursor:"pointer",fontSize:12,fontFamily:"inherit",fontWeight:700
        }}>
          ğŸ“¨ ×©×œ×— ×œ-{recipients.length} × ××¢× ×™×
        </button>
      </div>
    </div>
  );
}

function ModalShell({title,T,onClose,children,wide}) {
  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:1500,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
      <div style={{background:T.surface,borderRadius:13,padding:24,maxWidth:wide?680:460,width:"100%",maxHeight:"85vh",display:"flex",flexDirection:"column",boxShadow:"0 24px 60px rgba(0,0,0,0.3)"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <h3 style={{margin:0,fontSize:15,color:T.text}}>{title}</h3>
          <button onClick={onClose} style={{background:"none",border:"none",fontSize:22,cursor:"pointer",color:T.textMuted}}>Ã—</button>
        </div>
        <div style={{overflowY:"auto",flex:1}}>{children}</div>
      </div>
    </div>
  );
}

// â”€â”€ Participant add/edit modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ParticipantModal({p:initP,locations,T,L,onSave,onClose}) {
  if(!L) L=(k)=>k;
  const [p,setP]=useState(initP);
  const SLOTS=["×‘×•×§×¨ (08:00-12:00)","×¦×”×¨×™×™× (12:00-18:00)"];
  const DAYS=["×","×‘","×’","×“","×”","×•"];
  const DAY_NAMES={"×":L("dayA"),"×‘":L("dayB"),"×’":L("dayC"),"×“":L("dayD"),"×”":L("dayE"),"×•":L("dayF")};
  const toggleAvail=(day,slot)=>{
    setP(prev=>{
      const cur=prev.availability[day]||[];
      const next=cur.includes(slot)?cur.filter(s=>s!==slot):[...cur,slot];
      return{...prev,availability:{...prev.availability,[day]:next}};
    });
  };
  const inputStyle={width:"100%",padding:"7px 9px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:12,fontFamily:"inherit",boxSizing:"border-box",background:T.inputBg,color:T.text};
  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.55)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
      <div style={{background:T.surface,borderRadius:13,padding:24,maxWidth:560,width:"100%",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 24px 60px rgba(0,0,0,0.3)"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <h3 style={{margin:0,fontSize:15,color:T.text}}>{p.id?L("editParticipant"):L("addParticipant")}</h3>
          <button onClick={onClose} style={{background:"none",border:"none",fontSize:22,cursor:"pointer",color:T.textMuted}}>Ã—</button>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:14}}>
          {[{k:"name",l:L("fieldName")},{k:"email",l:L("fieldEmail")},{k:"phone",l:L("fieldPhone")},{k:"age",l:L("fieldAge")}].map(f=>(
            <div key={f.k}>
              <label style={{display:"block",fontSize:11,color:T.textMuted,marginBottom:3,fontWeight:600}}>{f.l}</label>
              <input value={p[f.k]||""} onChange={e=>setP(prev=>({...prev,[f.k]:e.target.value}))} style={inputStyle}/>
            </div>
          ))}
          <div>
            <label style={{display:"block",fontSize:11,color:T.textMuted,marginBottom:3,fontWeight:600}}>{L("fieldGender")}</label>
            <select value={p.gender||""} onChange={e=>setP(prev=>({...prev,gender:e.target.value}))} style={{...inputStyle}}>
              <option value="">{L("genderPick")}</option><option value="×’×‘×¨">{L("genderM")}</option><option value="××™×©×”">{L("genderF")}</option><option value="××—×¨">{L("genderO")}</option>
            </select>
          </div>
          <div>
            <label style={{display:"block",fontSize:11,color:T.textMuted,marginBottom:3,fontWeight:600}}>{L("fieldStatus")}</label>
            <select value={p.status} onChange={e=>setP(prev=>({...prev,status:e.target.value}))} style={{...inputStyle}}>
              {["pending","assigned","confirmed","completed","declined"].map(v=><option key={v} value={v}>{L("status"+v.charAt(0).toUpperCase()+v.slice(1))}</option>)}
            </select>
          </div>
        </div>
        <div style={{marginBottom:14}}>
          <label style={{display:"block",fontSize:11,color:T.textMuted,marginBottom:6,fontWeight:600}}>{L("colAvail")}</label>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:11}}>
            <thead>
              <tr>
                <th style={{padding:"5px 8px",textAlign:"right",color:T.textFaint}}>{L("colDay")}</th>
                {SLOTS.map(s=><th key={s} style={{padding:"5px 8px",textAlign:"center",color:T.textFaint}}>{s.includes("×‘×•×§×¨")?L("slotMorning"):L("slotAfternoon")}</th>)}
              </tr>
            </thead>
            <tbody>
              {DAYS.map(day=>(
                <tr key={day} style={{borderBottom:`1px solid ${T.border}`}}>
                  <td style={{padding:"5px 8px",fontWeight:600,color:T.text}}>{L("dayPrefix")}{DAY_NAMES[day]}</td>
                  {SLOTS.map(slot=>{
                    const on=(p.availability[day]||[]).includes(slot);
                    return(
                      <td key={slot} style={{textAlign:"center",padding:"4px"}}>
                        <button onClick={()=>toggleAvail(day,slot)} style={{background:on?"#4338CA":T.tablehead,color:on?"white":T.textMuted,border:`1px solid ${on?"#4338CA":T.border}`,borderRadius:5,padding:"3px 10px",cursor:"pointer",fontSize:10,fontFamily:"inherit",fontWeight:on?700:400,transition:"all .15s"}}>
                          {on?L("available"):L("notAvailable")}
                        </button>
                      </td>
                    );
                  })}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        <div style={{marginBottom:14}}>
          <label style={{display:"block",fontSize:11,color:T.textMuted,marginBottom:6,fontWeight:600}}>{L("fieldLocPref")}</label>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            {locations.length===0 && <span style={{fontSize:11,color:T.textFaint}}>{L("noLocations")}</span>}
            {locations.map((loc,i)=>{
              const pref=p.locPref||[];
              const on=pref.includes(loc.id);
              const colors=[
                {bg:"#EEF2FF",text:"#4338CA",border:"#C7D4FF"},
                {bg:"#FFF7ED",text:"#C2410C",border:"#FED7AA"},
                {bg:"#F0FDF4",text:"#166534",border:"#A7F3D0"},
                {bg:"#FDF4FF",text:"#7E22CE",border:"#E9D5FF"},
              ];
              const c=colors[i%colors.length];
              return(
                <button key={loc.id} type="button" onClick={()=>{
                  const cur=p.locPref||[];
                  const next=on?cur.filter(x=>x!==loc.id):[...cur,loc.id];
                  setP(prev=>({...prev,locPref:next}));
                }} style={{
                  background:on?c.bg:T.tablehead,
                  color:on?c.text:T.textMuted,
                  border:`1.5px solid ${on?c.border:T.border}`,
                  borderRadius:7,padding:"6px 14px",
                  cursor:"pointer",fontFamily:"inherit",
                  fontSize:12,fontWeight:on?700:400,
                  transition:"all .15s",
                }}>
                  {on?"âœ“ ":""}{loc.name}
                </button>
              );
            })}
          </div>
        </div>
        <div style={{marginBottom:14}}>
          <label style={{display:"block",fontSize:11,color:T.textMuted,marginBottom:3,fontWeight:600}}>{L("colNotes")}</label>
          <textarea value={p.notes||""} onChange={e=>setP(prev=>({...prev,notes:e.target.value}))} rows={2} style={{...inputStyle,resize:"vertical"}}/>
        </div>
        <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
          <button onClick={onClose} style={{background:T.tablehead,color:T.text,border:`1px solid ${T.border}`,padding:"8px 15px",borderRadius:7,cursor:"pointer",fontSize:13,fontFamily:"inherit"}}>{L("btnCancel")}</button>
          <button onClick={()=>onSave(p)} disabled={!p.name.trim()} style={{background:"#059669",color:"white",border:"none",padding:"8px 18px",borderRadius:7,cursor:"pointer",fontSize:13,fontWeight:700,fontFamily:"inherit",opacity:p.name.trim()?1:0.5}}>
            {p.id?L("btnSaveChanges"):L("btnAddConfirm")}
          </button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ Location modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LocModal({loc,T,onSave,onClose}) {
  const [name,setName]=useState(loc.name||"");
  const [rooms,setRooms]=useState(loc.rooms||[]);
  const [nr,setNr]=useState("");
  const inputStyle={padding:"7px 9px",border:`1px solid ${T.border}`,borderRadius:6,fontSize:12,fontFamily:"inherit",background:T.inputBg,color:T.text};
  return(
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:2000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
      <div style={{background:T.surface,borderRadius:12,padding:22,maxWidth:400,width:"100%",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"}}>
        <h3 style={{margin:"0 0 14px",fontSize:14,color:T.text}}>{loc.id?"×¢×¨×™×›×ª ××™×§×•×":"××™×§×•× ×—×“×©"}</h3>
        <div style={{marginBottom:12}}>
          <label style={{display:"block",fontSize:11,fontWeight:600,color:T.textMuted,marginBottom:4}}>×©×</label>
          <input value={name} onChange={e=>setName(e.target.value)} style={{...inputStyle,width:"100%",boxSizing:"border-box"}} placeholder="× ××œ, ×”×¨, ××•× ×™×‘×¨×¡×™×˜×”â€¦"/>
        </div>
        <div style={{marginBottom:14}}>
          <label style={{display:"block",fontSize:11,fontWeight:600,color:T.textMuted,marginBottom:6}}>×—×“×¨×™×</label>
          <div style={{display:"flex",gap:5,flexWrap:"wrap",marginBottom:7}}>
            {rooms.map(r=><span key={r} style={{background:"#EEF2FF",color:"#4338CA",borderRadius:5,padding:"2px 7px",fontSize:11,fontWeight:600,display:"flex",alignItems:"center",gap:4}}>{r}<button onClick={()=>setRooms(p=>p.filter(x=>x!==r))} style={{background:"none",border:"none",cursor:"pointer",color:"#9CA3AF",fontSize:12,padding:0}}>Ã—</button></span>)}
          </div>
          <div style={{display:"flex",gap:6}}>
            <input value={nr} onChange={e=>setNr(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"&&nr.trim()){setRooms(p=>[...p,nr.trim()]);setNr("");}}} placeholder="×©× ×—×“×¨ (Enter)" style={{...inputStyle,flex:1}}/>
            <button onClick={()=>{if(nr.trim()){setRooms(p=>[...p,nr.trim()]);setNr("");}}} style={{background:"#4338CA",color:"white",border:"none",padding:"7px 12px",borderRadius:6,cursor:"pointer",fontSize:12,fontFamily:"inherit",fontWeight:700}}>+</button>
          </div>
        </div>
        <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
          <button onClick={onClose} style={{background:T.tablehead,color:T.text,border:`1px solid ${T.border}`,padding:"7px 13px",borderRadius:6,cursor:"pointer",fontSize:12,fontFamily:"inherit"}}>{L("btnCancel")}</button>
          <button onClick={()=>onSave({...loc,name,rooms})} disabled={!name.trim()} style={{background:"#4338CA",color:"white",border:"none",padding:"7px 15px",borderRadius:6,cursor:"pointer",fontSize:12,fontWeight:700,fontFamily:"inherit"}}>×©××•×¨</button>
        </div>
      </div>
    </div>
  );
}


    ReactDOM.render(React.createElement(App), document.getElementById("root"));
  </script>
</body>
</html>
